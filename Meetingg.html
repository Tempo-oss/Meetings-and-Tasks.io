<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo Tasks</title>
    
    <!-- Tempo Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%22 y=%2275%22 font-family=%22Arial, sans-serif%22 font-size=%2280%22 font-weight=%22bold%22 fill=%22%234A443A%22 text-anchor=%22middle%22>T</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tempo: {
                            logo: '#4A443A',   // The dark olive/brown from the word TEMPO
                            ice: '#D2DFED',    // The light blue background of the product shot
                            blue: '#2A52BE',   // The blue weights
                            yellow: '#E5C531', // The yellow weights
                            red: '#D33534',    // The red weights
                            dark: '#262626',   // The charcoal rack
                            hover: '#1e3b8a'   // Hover state for blue buttons
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .tempo-btn {
            background-color: #262626; /* Charcoal */
            color: white;
            border-radius: 9999px; /* Pill shape */
            transition: all 0.2s;
        }
        .tempo-btn:hover {
            background-color: #4A443A; /* Logo Olive */
            transform: translateY(-1px);
        }
        .tempo-btn:disabled {
            opacity: 0.5;
            transform: none;
        }
        
        .dark .tempo-btn { background-color: #D2DFED; color: #262626; }
        .dark .tempo-btn:hover { background-color: #ffffff; }

        /* Admin Edit Mode Input */
        .admin-edit-input {
            border: 1px dashed #2A52BE;
            background-color: #eff6ff;
            padding: 2px 4px;
            border-radius: 4px;
            width: 100%;
            color: #111827;
        }
        .dark .admin-edit-input {
            background-color: rgba(42, 82, 190, 0.1);
            color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-screen overflow-hidden transition-colors duration-200">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Configuration ---
        const SUPABASE_URL = 'https://yasoowbpyknuikdvlahz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlhc29vd2JweWtudWlrZHZsYWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzYxMzQsImV4cCI6MjA4NTM1MjEzNH0.CZCFL19K0JF_wxtnnTha3Kbd1fwJEa1D1bhK7jkUZyA';

        // --- Utils ---
        const getTodayISO = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };

        const calculateDaysRemaining = (endDate) => {
            if (!endDate) return null;
            const end = new Date(endDate);
            const today = new Date();
            end.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            const diffTime = end - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const DEPARTMENTS = ['Managers', 'Leaders', 'Quality', 'Training', 'HR', 'Mentors', 'WFM', 'Eng team'];
        const ADMIN_EMAILS = ['mohamed.abdelmagid@tempo.fit', 'halim@tempo.fit', 'nancy@tempo.fit'];

        const SQL_SETUP_INSTRUCTIONS = `
-- Run these commands in your Supabase SQL Editor to fix permissions and missing columns:

-- 1. Create Tables (Safe to run, will skip if they exist)
create table if not exists meetings (
    id text primary key,
    title text,
    date text,
    time text,
    duration text,
    participants jsonb, 
    doc_id text,
    google_calendar_id text,
    synced boolean,
    platform text,
    google_doc_link text,
    video_link text
);

create table if not exists tasks (
    id text primary key,
    meeting_id text,
    text text,
    assignee text,
    assigner text,
    done boolean,
    status text default 'pending',
    obstacles text,
    start_date date,
    end_date date,
    reminder_sent boolean default false,
    deleted boolean default false
);

create table if not exists team_members (
    email text primary key,
    name text,
    team text,
    role text,
    managed_teams text[],
    system_role text default 'user',
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table if not exists pending_emails (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    recipient_email text NOT NULL,
    subject text NOT NULL,
    body text NOT NULL,
    status text DEFAULT 'pending',
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. FIX MISSING COLUMNS
alter table meetings add column if not exists video_link text;
alter table meetings add column if not exists google_doc_link text;
alter table tasks add column if not exists assigner text;
alter table tasks add column if not exists deleted boolean default false;

-- 3. Disable RLS to allow writing
alter table meetings disable row level security;
alter table tasks disable row level security;
alter table team_members disable row level security;
alter table pending_emails disable row level security;

-- 4. Safely Enable Realtime
do $$
begin
  if not exists (select 1 from pg_publication_tables where pubname = 'supabase_realtime' and tablename = 'meetings') then
    alter publication supabase_realtime add table meetings, tasks, team_members;
  end if;
end $$;
`;

        // --- Icon Component ---
        const Icon = ({ name, className, ...props }) => {
            const icons = {
                Moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />,
                Sun: <><circle cx="12" cy="12" r="4" /><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" /></>,
                Calendar: <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-13 0V2m12 2V2M3 10h18" />,
                Clock: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm0-14v6l4 2" />,
                Video: <path d="m22 8-6 4 6 4V8Z M16 19h-4m-4 0H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z" />,
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
                Search: <path d="m21 21-4.3-4.3 M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" />,
                Plus: <path d="M12 5v14M5 12h14" />,
                ChevronLeft: <path d="m15 18-6-6 6-6" />,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5" />,
                Database: <path d="M3 5V19A9 3 0 0 0 21 19V5 M3 5A9 3 0 0 1 21 5 M3 5A9 3 0 0 0 21 5 M3 12A9 3 0 0 0 21 12" />,
                UploadCloud: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242 M12 12v9 M16 16l-4-4-4 4" />,
                Trash2: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" />,
                AlertCircle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9h2m-2 4h2" />,
                CheckSquare: <path d="m9 11 3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />,
                FileText: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6" />,
                Bold: <path d="M14 12a4 4 0 0 0 0-8H6v8 M15 20a4 4 0 0 0 0-8H6v8Z" />,
                Italic: <path d="M19 4h-9M14 20H5M15 4L9 20" />,
                Underline: <path d="M6 4v6a6 6 0 0 0 12 0V4 M4 20h16" />,
                Share2: <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13" />,
                Circle: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" />,
                CheckCircle2: <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Zm-1-9 2 2 4-4" />,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
                ExternalLink: <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3" />,
                Mail: <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z M22 6l-10 7L2 6" />,
                UserPlus: <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M8.5 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z M20 8v6M23 11h-6" />,
                AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />,
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83 M22 12A10 10 0 0 0 12 2v10z" />,
                Crown: <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />,
                Briefcase: <path d="M20 7h-3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2 2H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z M9 7V5h6v2 M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
                Hash: <path d="M4 9h16 M4 15h16 M10 3L8 21 M16 3l-2 18" />,
                Layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
                Filter: <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
                XCircle: <path d="M22 12A10 10 0 1 1 12 2a10 10 0 0 1 0 20zM15 9l-6 6M9 9l6 6" />,
                Key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />,
                Edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
                Send: <path d="M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z" />,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            };

            if (name === 'Google') {
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className={className} {...props}>
                        <g>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            <path d="M24 12c0-.82-.07-1.63-.2-2.43H12v4.6h6.77c-.29 1.55-1.16 2.87-2.48 3.75l.02-.02 3.55 2.75c2.08-1.91 3.28-4.73 3.28-8.22z" fill="#4285F4"/>
                        </g>
                    </svg>
                );
            }

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className} 
                    {...props}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" />}
                </svg>
            );
        };

        // --- Sub-Components ---
        const UserAvatar = ({ user, size = 'md' }) => {
            const sizeClasses = { sm: 'w-6 h-6 text-xs', md: 'w-8 h-8 text-sm', lg: 'w-10 h-10 text-base' };
            if (!user) return null;
            const name = user.name || user.email || 'Unknown';
            const initial = name.substring(0,2).toUpperCase();
            return (
                <div className={`${sizeClasses[size]} bg-tempo-dark rounded-full flex items-center justify-center text-white font-medium ring-2 ring-white dark:ring-gray-800 select-none uppercase`} title={name}>
                    {initial}
                </div>
            );
        };

        const AppHeader = ({ currentUser, onLogout, onSync, dbStatus, onBack, title, isSyncing, syncRange, setSyncRange, meeting, lastSynced, isDarkMode, toggleDarkMode }) => (
            <header className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 h-16 flex items-center justify-between px-4 sm:px-6 shrink-0 sticky top-0 z-20 text-gray-900 dark:text-white transition-colors duration-200">
                <div className="flex items-center space-x-4 flex-1 min-w-0">
                    {onBack ? (
                        <button onClick={onBack} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-tempo-logo dark:text-gray-300 transition-colors flex-shrink-0">
                            <Icon name="ChevronLeft" className="w-5 h-5" />
                        </button>
                    ) : (
                        <div className="flex-shrink-0 font-bold text-xl tracking-[0.2em] text-tempo-logo dark:text-white select-none">
                            TEMPO
                        </div>
                    )}
                    
                    {title && title !== 'Tempo Tasks' && (
                        <div className="min-w-0 flex items-center">
                            <span className="text-gray-300 dark:text-gray-700 mr-3 select-none">|</span>
                            <h1 className="font-semibold text-gray-600 dark:text-gray-200 text-sm sm:text-base leading-tight truncate">{title}</h1>
                        </div>
                    )}

                    {dbStatus === 'connected' && <span className="hidden sm:inline-flex bg-tempo-blue/10 text-tempo-blue dark:bg-tempo-blue/20 dark:text-blue-300 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full flex-shrink-0 ml-2">Live</span>}
                    {dbStatus === 'setup_required' && <span className="hidden sm:inline-flex bg-tempo-red/10 text-tempo-red dark:bg-tempo-red/20 dark:text-red-300 text-[10px] uppercase font-bold tracking-wide px-2 py-0.5 rounded-full flex-shrink-0 ml-2">DB Setup</span>}
                </div>
                
                <div className="flex items-center space-x-3 sm:space-x-4">
                    <button onClick={toggleDarkMode} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-500 dark:text-gray-400 transition-colors" title="Toggle Theme">
                        <Icon name={isDarkMode ? 'Sun' : 'Moon'} className="w-5 h-5" />
                    </button>

                    {/* Join Meeting Button */}
                    {meeting && meeting.video_link && (
                        <a 
                            href={meeting.video_link} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="flex items-center bg-tempo-blue hover:bg-tempo-hover text-white px-3 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm animate-pulse hover:animate-none"
                        >
                            <Icon name="Video" className="w-4 h-4 mr-2" />
                            <span className="hidden sm:inline">Join Call</span>
                            <span className="sm:hidden">Join</span>
                        </a>
                    )}

                    {onSync && (dbStatus === 'empty' || dbStatus === 'connected') && 
                        <div className="flex items-center space-x-2">
                            <div className="flex flex-col items-end mr-2">
                                <select 
                                    value={syncRange}
                                    onChange={(e) => setSyncRange(e.target.value)}
                                    className="text-xs border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded border p-1 focus:outline-none focus:ring-1 focus:ring-tempo-blue hidden sm:block mb-0.5"
                                >
                                    <option value="upcoming">Upcoming</option>
                                    <option value="past_month">Past 30 Days</option>
                                </select>
                                {lastSynced && <span className="text-[9px] text-gray-500 hidden sm:block">Last: {lastSynced}</span>}
                            </div>
                            <button onClick={onSync} disabled={isSyncing} className="text-sm font-medium text-tempo-blue hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center disabled:opacity-50" title="Click to refresh from Google Calendar">
                                <Icon name="RefreshCw" className={`w-4 h-4 mr-1 ${isSyncing ? 'animate-spin' : ''}`}/> 
                                <span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Sync'}</span>
                            </button>
                        </div>
                    }
                    <div className="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1 hidden sm:block"></div>
                    <div className="flex items-center space-x-2">
                        <UserAvatar user={currentUser} size="sm" />
                        <div className="hidden md:flex flex-col items-start">
                            <span className="text-sm font-medium text-gray-700 dark:text-gray-200 truncate max-w-[100px]">{currentUser.name}</span>
                            <span className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">{currentUser.system_role}</span>
                        </div>
                        <button onClick={onLogout} className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:text-tempo-red hover:border-tempo-red dark:hover:text-red-400 dark:hover:border-red-400 px-3 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm ml-2" title="Log Out">
                            Log Out
                        </button>
                    </div>
                </div>
            </header>
        );

        const MeetingCard = ({ meeting, onClick, onAutoImport }) => {
            const participants = meeting.participants || [];
            
            const handleClick = (e) => {
                if (meeting.google_doc_link && onAutoImport) {
                    onAutoImport(meeting, true); // true = silent
                }
                onClick();
            };

            return (
                <div onClick={handleClick} className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-5 hover:shadow-lg hover:border-tempo-blue dark:hover:border-tempo-blue transition-all cursor-pointer group">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-semibold text-gray-900 dark:text-gray-100 group-hover:text-tempo-blue dark:group-hover:text-tempo-blue transition-colors">{meeting.title}</h3>
                            <div className="flex items-center text-gray-500 dark:text-gray-400 text-sm mt-1 space-x-3">
                                {meeting.date && <span className="flex items-center"><Icon name="Calendar" className="w-3 h-3 mr-1" /> {meeting.date}</span>}
                                {meeting.time && <span className="flex items-center"><Icon name="Clock" className="w-3 h-3 mr-1" /> {meeting.time}</span>}
                            </div>
                        </div>
                        <div className="flex items-center space-x-2">
                            {meeting.video_link && (
                                <div className="bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-400 p-1.5 rounded-full" title="Video Link Available">
                                    <Icon name="Video" className="w-4 h-4" />
                                </div>
                            )}
                            {meeting.google_doc_link && (
                                <a 
                                    href={meeting.google_doc_link} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    onClick={(e) => e.stopPropagation()} 
                                    className="bg-tempo-yellow/10 dark:bg-tempo-yellow/20 text-yellow-600 dark:text-yellow-500 p-1.5 rounded-full hover:bg-tempo-yellow/20 transition-colors"
                                    title="Open Google Doc"
                                >
                                    <Icon name="FileText" className="w-4 h-4" />
                                </a>
                            )}
                            {meeting.synced && <div className="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 p-1.5 rounded-full"><Icon name="Calendar" className="w-4 h-4" /></div>}
                        </div>
                    </div>
                    <div className="flex justify-between items-center mt-4">
                        <div className="flex -space-x-2">
                            {participants.slice(0,4).map((user, i) => <UserAvatar key={i} user={user} size="sm" />)}
                            {participants.length > 4 && <div className="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-[10px] ring-2 ring-white dark:ring-gray-800 text-gray-700 dark:text-gray-300">+{participants.length - 4}</div>}
                        </div>
                        <div className="flex items-center text-gray-400 dark:text-gray-500 text-sm space-x-1 group-hover:text-tempo-blue dark:group-hover:text-tempo-blue transition-colors">
                            <span>Open Tasks</span>
                            <Icon name="ChevronLeft" className="w-4 h-4 rotate-180" />
                        </div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, meetingTitle, onStatusChange, onObstacleChange, onDateChange, currentUser, onDelete, onUpdateText, onRestore, isTrash }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [isEditingText, setIsEditingText] = useState(false);
            const [editedText, setEditedText] = useState(task.text);
            const currentStatus = task.status || (task.done ? 'completed' : 'pending');
            const isCompleted = currentStatus === 'completed';
            const daysRemaining = calculateDaysRemaining(task.end_date);
            const isOverdue = daysRemaining !== null && daysRemaining < 0 && !isCompleted;
            const isAdmin = currentUser?.system_role === 'admin';
            
            const handleIconClick = (e) => {
                e.stopPropagation();
                if (!isTrash) {
                    onStatusChange(task.id, isCompleted ? 'pending' : 'completed');
                }
            };

            const handleTextSave = (e) => {
                e.stopPropagation();
                if (editedText !== task.text && onUpdateText) {
                    onUpdateText(task.id, editedText);
                }
                setIsEditingText(false);
            };

            return (
                <div className={`bg-white dark:bg-gray-800 border ${isTrash ? 'border-gray-200 dark:border-gray-700 opacity-75' : (isCompleted ? 'border-tempo-blue/20 dark:border-tempo-blue/30 bg-tempo-blue/5 dark:bg-tempo-blue/10' : 'border-gray-200 dark:border-gray-700')} rounded-lg transition-all duration-200 hover:shadow-md mb-3`}>
                    {/* Collapsed View / Header */}
                    <div 
                        className="flex items-start p-3 cursor-pointer group" 
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        {/* Checkbox Icon */}
                        <div 
                            className={`mt-0.5 mr-3 flex-shrink-0 transition-colors ${isTrash ? 'text-gray-300 dark:text-gray-600' : (isCompleted ? 'text-tempo-blue hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300' : 'text-gray-300 dark:text-gray-500 hover:text-tempo-blue dark:hover:text-tempo-blue')}`}
                            onClick={handleIconClick}
                            title={isTrash ? "Restoring..." : (isCompleted ? "Mark as pending" : "Mark as completed")}
                        >
                            {isCompleted ? (
                                <Icon name="CheckCircle2" className="w-5 h-5 fill-tempo-blue/10 dark:fill-tempo-blue/20" />
                            ) : (
                                <Icon name="Circle" className="w-5 h-5" />
                            )}
                        </div>

                        {/* Task Title & Summary */}
                        <div className="flex-1 min-w-0">
                            {isEditingText ? (
                                <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                                    <input 
                                        type="text" 
                                        value={editedText}
                                        onChange={(e) => setEditedText(e.target.value)}
                                        className="admin-edit-input text-sm font-medium"
                                        autoFocus
                                        onKeyDown={(e) => { if(e.key === 'Enter') handleTextSave(e); }}
                                    />
                                    <button onClick={handleTextSave} className="text-tempo-blue hover:text-blue-800 dark:text-blue-400"><Icon name="CheckCircle2" className="w-4 h-4"/></button>
                                </div>
                            ) : (
                                <div className={`text-sm ${isTrash ? 'text-gray-400 dark:text-gray-500 line-through decoration-gray-300 dark:decoration-gray-600' : (isCompleted ? 'text-gray-600 dark:text-gray-300 font-medium' : 'text-gray-900 dark:text-gray-100 font-medium')}`}>
                                    {task.text}
                                    {isAdmin && !isTrash && (
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); setIsEditingText(true); }}
                                            className="ml-2 text-gray-300 dark:text-gray-600 hover:text-tempo-blue dark:hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Edit Text (Admin)"
                                        >
                                            <Icon name="Edit" className="w-3 h-3 inline" />
                                        </button>
                                    )}
                                </div>
                            )}
                            
                            {/* Summary Metadata (Visible when collapsed) */}
                            {!isExpanded && (
                                <div className="flex items-center mt-1.5 space-x-3 text-xs text-gray-400 dark:text-gray-500">
                                    {task.end_date && (
                                        <span className={`flex items-center ${isOverdue ? 'text-tempo-red dark:text-red-400 font-bold' : ''}`}>
                                            <Icon name="Clock" className="w-3 h-3 mr-1" />
                                            {isOverdue ? `Overdue (${Math.abs(daysRemaining)}d)` : (daysRemaining === 0 ? 'Today' : task.end_date)}
                                        </span>
                                    )}
                                    {task.assigneeName && (
                                        <span className="flex items-center">
                                            <span className="w-4 h-4 rounded-full bg-gray-100 dark:bg-gray-700 text-[8px] flex items-center justify-center mr-1 text-gray-600 dark:text-gray-300 uppercase border border-gray-200 dark:border-gray-600">
                                                {task.assigneeName.substring(0,1)}
                                            </span>
                                            {task.assigneeName.split(' ')[0]}
                                        </span>
                                    )}
                                    {task.assigner && (task.assigner === currentUser?.email || task.assigner === currentUser?.id) && (
                                        <span className="text-[10px] bg-tempo-yellow/20 dark:bg-tempo-yellow/20 text-yellow-800 dark:text-yellow-500 px-1.5 py-0.5 rounded border border-tempo-yellow/30 dark:border-yellow-800/50">
                                            Assigned by you
                                        </span>
                                    )}
                                    {isTrash && (
                                        <span className="text-[10px] bg-tempo-red/10 dark:bg-tempo-red/20 text-tempo-red dark:text-red-400 px-1.5 py-0.5 rounded border border-tempo-red/20 dark:border-red-800">
                                            Deleted
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Actions */}
                        {isTrash ? (
                            <button 
                                onClick={(e) => { e.stopPropagation(); onRestore(task.id); }}
                                className="mr-2 text-tempo-blue hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                title="Restore Task"
                            >
                                <Icon name="RotateCcw" className="w-4 h-4" />
                            </button>
                        ) : (
                            isAdmin && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onDelete(task.id); }}
                                    className="mr-2 text-gray-300 dark:text-gray-600 hover:text-tempo-red dark:hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"
                                    title="Delete Task (Admin Only)"
                                >
                                    <Icon name="Trash2" className="w-4 h-4" />
                                </button>
                            )
                        )}

                        {/* Expand Chevron */}
                        <div className={`ml-2 text-gray-300 dark:text-gray-600 transition-transform duration-200 ${isExpanded ? 'rotate-90' : '-rotate-90'}`}>
                            <Icon name="ChevronLeft" className="w-4 h-4" />
                        </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                        <div className="px-4 pb-4 pt-0 pl-11">
                            <div className="pt-3 border-t border-gray-100/60 dark:border-gray-700/60 flex flex-col gap-3 animate-in fade-in zoom-in-95 duration-200">
                                
                                {/* Meta Controls Row */}
                                <div className="flex flex-wrap gap-4 text-xs">
                                    {/* Status Select */}
                                    {!isTrash && (
                                        <div className="flex flex-col gap-1">
                                            <label className="font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider text-[10px]">Status</label>
                                            <select
                                                value={currentStatus}
                                                onChange={(e) => onStatusChange(task.id, e.target.value)}
                                                className={`border rounded px-2 py-1.5 outline-none focus:ring-1 focus:ring-tempo-blue ${currentStatus === 'completed' ? 'text-tempo-blue dark:text-blue-400 bg-tempo-blue/10 dark:bg-tempo-blue/20 border-tempo-blue/30 dark:border-blue-800' : 'text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700'}`}
                                                onClick={(e) => e.stopPropagation()}
                                            >
                                                <option value="pending">Pending</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    )}

                                    {/* Due Date */}
                                    <div className="flex flex-col gap-1">
                                        <label className="font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider text-[10px]">Due Date</label>
                                        <input 
                                            type="date" 
                                            value={task.end_date || ''}
                                            onChange={(e) => onDateChange && onDateChange(task.id, e.target.value)}
                                            className="border border-gray-200 dark:border-gray-700 rounded px-2 py-1.5 text-gray-700 dark:text-gray-300 outline-none focus:border-tempo-blue bg-white dark:bg-gray-900"
                                            onClick={(e) => e.stopPropagation()}
                                            disabled={isTrash}
                                        />
                                    </div>

                                    {/* Assignee Display */}
                                    <div className="flex flex-col gap-1">
                                        <label className="font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider text-[10px]">Assignee</label>
                                        <div className="flex items-center h-[29px] text-gray-700 dark:text-gray-300">
                                            {task.assigneeName || 'Unassigned'}
                                        </div>
                                    </div>

                                    {/* Source */}
                                    {meetingTitle && (
                                        <div className="flex flex-col gap-1 max-w-[150px]">
                                            <label className="font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider text-[10px]">Source</label>
                                            <div className="truncate text-gray-500 dark:text-gray-400 h-[29px] flex items-center" title={meetingTitle}>
                                                {meetingTitle}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Obstacles / Notes */}
                                <div className="mt-1">
                                    <label className="flex items-center text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-1.5">
                                        <Icon name="FileText" className="w-3 h-3 mr-1" />
                                        Notes / Obstacles
                                    </label>
                                    <textarea
                                        className="w-full text-xs p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:bg-white dark:focus:bg-gray-800 focus:ring-1 focus:ring-tempo-blue outline-none transition-colors"
                                        rows="2"
                                        placeholder="Add notes, blockers, or updates..."
                                        value={task.obstacles || ''}
                                        onChange={(e) => onObstacleChange(task.id, e.target.value)}
                                        onClick={(e) => e.stopPropagation()}
                                        disabled={isTrash}
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ReportsView = ({ meetings, tasks, attendees, teamMembers }) => {
            const [filterOwner, setFilterOwner] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterDate, setFilterDate] = useState('');
            const [chartStartDate, setChartStartDate] = useState('');
            const [chartEndDate, setChartEndDate] = useState('');
            const [reportGenerated, setReportGenerated] = useState(false);
            
            // EXCLUDE DELETED TASKS FROM REPORTS
            const activeTasks = useMemo(() => tasks.filter(t => !t.deleted), [tasks]);

            const uniqueOwners = useMemo(() => {
                const owners = new Map();
                activeTasks.forEach(t => {
                    if (!t.assignee) return;
                    const user = attendees.find(u => u.email === t.assignee || u.id === t.assignee);
                    const email = user && user.email ? user.email : t.assignee;
                    if (!owners.has(email)) {
                        owners.set(email, user || { name: email, email: email });
                    }
                });
                return Array.from(owners.values());
            }, [activeTasks, attendees]);

            const chartData = useMemo(() => {
                 let filtered = activeTasks;
                 if (chartStartDate) filtered = filtered.filter(t => t.start_date >= chartStartDate);
                 if (chartEndDate) filtered = filtered.filter(t => t.start_date <= chartEndDate);

                 const stats = {};
                 filtered.forEach(t => {
                     const uid = t.assignee;
                     const user = attendees.find(u => u.id === uid || u.email === uid);
                     const name = user ? (user.name || user.email).split(' ')[0] : (uid || 'Unassigned'); 
                     
                     if (!stats[name]) stats[name] = { name, pending: 0, completed: 0, total: 0 };
                     
                     const isCompleted = t.status === 'completed' || t.done;
                     if (isCompleted) stats[name].completed++;
                     else stats[name].pending++;
                     stats[name].total++;
                 });
                 
                 return Object.values(stats).sort((a,b) => b.total - a.total);
            }, [activeTasks, attendees, chartStartDate, chartEndDate]);
            const maxChartVal = Math.max(...chartData.map(d => d.total), 1);

            // New Flat Report Data mapped to a Table
            const flatReportData = useMemo(() => {
                const data = [];
                const getAssigneeEmail = (idOrEmail) => {
                    const user = attendees.find(u => u.id === idOrEmail || u.email === idOrEmail);
                    return user && user.email ? user.email : idOrEmail;
                };
                
                const getManager = (userEmail) => {
                    const member = teamMembers.find(tm => tm.email === userEmail);
                    if (!member || !member.team || member.team === 'Unassigned') return '-';
                    const manager = teamMembers.find(m => (m.team === member.team && m.role === 'Owner') || (m.managed_teams && m.managed_teams.includes(member.team)));
                    return manager ? manager.name || manager.email : '-';
                };

                activeTasks.forEach(task => {
                    const ownerEmail = getAssigneeEmail(task.assignee);
                    if (filterOwner !== 'all' && ownerEmail !== filterOwner) return;
                    
                    const status = task.status || (task.done ? 'completed' : 'pending');
                    if (filterStatus !== 'all' && status !== filterStatus) return;

                    const mtg = meetings.find(m => m.id === task.meetingId);
                    const source = mtg ? mtg.title : (task.meeting_id === 'standalone' ? 'Personal Task' : 'Unknown');
                    const dateAssigned = task.start_date || (mtg ? mtg.date : '') || 'N/A';
                    
                    if (filterDate && dateAssigned !== filterDate) return;

                    const ownerUser = attendees.find(u => u.email === ownerEmail) || { name: ownerEmail };
                    
                    data.push({
                        id: task.id,
                        text: task.text,
                        status: status,
                        owner: ownerUser.name || ownerEmail || 'Unassigned',
                        manager: getManager(ownerEmail),
                        dateAssigned: dateAssigned,
                        dueDate: task.end_date || 'N/A',
                        source: source
                    });
                });
                
                return data.sort((a, b) => {
                    const dateA = new Date(a.dateAssigned === 'N/A' ? 0 : a.dateAssigned);
                    const dateB = new Date(b.dateAssigned === 'N/A' ? 0 : b.dateAssigned);
                    return dateA - dateB;
                });
            }, [activeTasks, meetings, attendees, teamMembers, filterOwner, filterStatus, filterDate]);

            const clearFilters = () => {
                setFilterOwner('all');
                setFilterStatus('all');
                setFilterDate('');
                setReportGenerated(false);
            };

            const handleGenerate = () => {
                setReportGenerated(true);
            };

            const totalTasks = chartData.reduce((acc, curr) => acc + curr.total, 0);
            const totalCompleted = chartData.reduce((acc, curr) => acc + curr.completed, 0);
            const completionRate = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;

            return (
                <div className="space-y-6">
                    {/* STATS & CHART SECTION */}
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 transition-colors">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center">
                                    <Icon name="PieChart" className="w-5 h-5 mr-2 text-tempo-blue" />
                                    Task Distribution
                                </h3>
                                <div className="flex gap-4 mt-2 text-xs text-gray-500 dark:text-gray-400">
                                    <span>Total: <strong className="text-gray-900 dark:text-white">{totalTasks}</strong></span>
                                    <span>Completed: <strong className="text-tempo-blue dark:text-blue-400">{totalCompleted}</strong> ({completionRate}%)</span>
                                    <span>Pending: <strong className="text-tempo-yellow dark:text-yellow-400">{totalTasks - totalCompleted}</strong></span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                                <input type="date" value={chartStartDate} onChange={e => setChartStartDate(e.target.value)} className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded p-1 outline-none" />
                                <span>to</span>
                                <input type="date" value={chartEndDate} onChange={e => setChartEndDate(e.target.value)} className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded p-1 outline-none" />
                            </div>
                        </div>
                        
                        <div className="h-56 flex items-end gap-3 sm:gap-6 overflow-x-auto pb-6 px-2">
                             {chartData.length === 0 ? (
                                <div className="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500 text-sm">No data for selected period</div>
                             ) : (
                                 chartData.map((d, i) => (
                                     <div key={i} className="flex flex-col items-center min-w-[50px] flex-1 group relative h-full justify-end">
                                          {/* Tooltip */}
                                          <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10 whitespace-nowrap pointer-events-none shadow-md">
                                              {d.name}<br/>
                                              Done: {d.completed} | Pending: {d.pending}
                                          </div>
                                          
                                          {/* Bar Container */}
                                          <div 
                                              className="w-full max-w-[40px] flex flex-col-reverse rounded-t-md overflow-hidden bg-gray-100 dark:bg-gray-700 relative shadow-sm"
                                              style={{ height: `${Math.max((d.total / maxChartVal) * 100, 5)}%` }} // Ensure min height for visibility
                                          >
                                              {/* Completed Segment (Blue) */}
                                              <div 
                                                  style={{ height: `${(d.completed / d.total) * 100}%` }} 
                                                  className="bg-tempo-blue w-full transition-all duration-500 relative flex items-center justify-center overflow-hidden"
                                              >
                                                  {d.completed > 0 && <span className="text-[10px] font-bold text-white shadow-sm">{d.completed}</span>}
                                              </div>
                                              {/* Pending Segment (Yellow) */}
                                              <div 
                                                  style={{ height: `${(d.pending / d.total) * 100}%` }} 
                                                  className="bg-tempo-yellow w-full transition-all duration-500 relative flex items-center justify-center overflow-hidden"
                                              >
                                                  {d.pending > 0 && <span className="text-[10px] font-bold text-gray-900 shadow-sm">{d.pending}</span>}
                                              </div>
                                          </div>
                                          
                                          <div className="text-[10px] text-gray-500 dark:text-gray-400 mt-2 truncate w-full text-center font-medium" title={d.name}>{d.name}</div>
                                      </div>
                                  ))
                             )}
                        </div>
                        
                        {/* Legend */}
                        <div className="flex justify-center gap-6 mt-2 border-t border-gray-100 dark:border-gray-700 pt-4">
                            <div className="flex items-center text-xs text-gray-600 dark:text-gray-400"><div className="w-3 h-3 bg-tempo-yellow rounded-sm mr-2"></div>Pending</div>
                            <div className="flex items-center text-xs text-gray-600 dark:text-gray-400"><div className="w-3 h-3 bg-tempo-blue rounded-sm mr-2"></div>Completed</div>
                        </div>
                    </div>

                    {/* Filters and List... */}
                      <div className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-wrap gap-4 items-end shadow-sm transition-colors">
                        <div className="flex flex-col gap-1 w-full sm:w-auto flex-1 min-w-[150px]">
                            <label className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Owner</label>
                            <select value={filterOwner} onChange={(e) => setFilterOwner(e.target.value)} className="text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm border p-2 w-full focus:ring-2 focus:ring-tempo-blue outline-none">
                                <option value="all">All Owners</option>
                                {uniqueOwners.map(u => <option key={u.email} value={u.email}>{u.name || u.email}</option>)}
                            </select>
                        </div>
                        <div className="flex flex-col gap-1 w-full sm:w-auto w-[120px]">
                            <label className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</label>
                            <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm border p-2 w-full focus:ring-2 focus:ring-tempo-blue outline-none">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div className="flex flex-col gap-1 w-full sm:w-auto">
                            <label className="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</label>
                            <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm border p-2 focus:ring-2 focus:ring-tempo-blue outline-none"/>
                        </div>
                        <button onClick={handleGenerate} className="tempo-btn px-4 py-2 text-sm font-medium shadow-sm mb-[1px]">
                            Generate Report
                        </button>
                        <button onClick={clearFilters} className="text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md transition-colors flex items-center mb-[1px]" title="Reset all filters">
                            <Icon name="XCircle" className="w-4 h-4 mr-1" /> Clear
                        </button>
                    </div>

                    {/* Report Table List */}
                    {reportGenerated && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div className="p-4 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 className="font-bold text-gray-800 dark:text-gray-100 flex items-center"><Icon name="FileText" className="w-4 h-4 mr-2 text-tempo-blue" /> Generated Report</h3>
                                <span className="text-xs text-gray-500 dark:text-gray-400">{flatReportData.length} tasks found</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-gray-600 dark:text-gray-300">
                                    <thead className="bg-gray-50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400 uppercase text-[10px] font-bold tracking-wider border-b border-gray-200 dark:border-gray-700">
                                        <tr>
                                            <th className="px-4 py-3">Task</th>
                                            <th className="px-4 py-3">Status</th>
                                            <th className="px-4 py-3">Owner</th>
                                            <th className="px-4 py-3">Manager</th>
                                            <th className="px-4 py-3">Date Assigned</th>
                                            <th className="px-4 py-3">Due Date</th>
                                            <th className="px-4 py-3">Source</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 dark:divide-gray-700/50">
                                        {flatReportData.length === 0 ? (
                                            <tr><td colSpan="7" className="px-4 py-8 text-center text-gray-500">No tasks found matching your filters.</td></tr>
                                        ) : (
                                            flatReportData.map(row => (
                                                <tr key={row.id} className="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                                    <td className="px-4 py-3 font-medium text-gray-800 dark:text-gray-200 max-w-[200px] truncate" title={row.text}>{row.text}</td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${row.status === 'completed' ? 'bg-tempo-blue/10 text-tempo-blue dark:text-blue-400' : 'bg-tempo-yellow/20 text-yellow-800 dark:text-yellow-500'}`}>
                                                            {row.status}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 whitespace-nowrap">{row.owner}</td>
                                                    <td className="px-4 py-3 whitespace-nowrap text-gray-500 dark:text-gray-400">{row.manager}</td>
                                                    <td className="px-4 py-3 text-xs whitespace-nowrap">{row.dateAssigned}</td>
                                                    <td className="px-4 py-3 text-xs whitespace-nowrap">{row.dueDate}</td>
                                                    <td className="px-4 py-3 text-xs max-w-[150px] truncate text-gray-500 dark:text-gray-400" title={row.source}>{row.source}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TeamList = ({ teamMembers, onAddMember, onUpdateMember, onRemoveMember, colleagues }) => {
            const [newEmail, setNewEmail] = useState('');
            const [newName, setNewName] = useState('');
            const [newTeam, setNewTeam] = useState(DEPARTMENTS[0]);
            const [newRole, setNewRole] = useState('Member');
            const [newSystemRole, setNewSystemRole] = useState('user');
            const [unassignedExpanded, setUnassignedExpanded] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!newEmail || !newName) return;
                onAddMember(newEmail, newName, newTeam, newRole, newSystemRole);
                setNewEmail('');
                setNewName('');
            };

            const unassigned = useMemo(() => colleagues.filter(c => {
                const existing = teamMembers.find(t => t.email === (c.email || c.id));
                return !existing || !existing.team || !DEPARTMENTS.includes(existing.team);
            }), [colleagues, teamMembers]);

            const displayUnassigned = unassigned.map(c => teamMembers.find(t => t.email === (c.email || c.id)) || c);

            const handleAddManagedTeam = (email, currentManaged, newTeam) => {
                if (!newTeam || currentManaged.includes(newTeam)) return;
                const updated = [...currentManaged, newTeam];
                onUpdateMember(email, { managed_teams: updated });
            };

            const handleRemoveManagedTeam = (email, currentManaged, teamToRemove) => {
                const updated = currentManaged.filter(t => t !== teamToRemove);
                onUpdateMember(email, { managed_teams: updated });
            };
            
            const handleRemoveTeamMember = async (email) => {
                onRemoveMember(email);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 transition-colors">
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center"><Icon name="UserPlus" className="w-5 h-5 mr-2 text-tempo-blue" /> Add Team Member</h3>
                        <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-4">
                            <input type="text" placeholder="Name" value={newName} onChange={(e) => setNewName(e.target.value)} className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue outline-none"/>
                            <input type="email" placeholder="Email (@tempo.fit)" value={newEmail} onChange={(e) => setNewEmail(e.target.value)} className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue outline-none"/>
                            <select value={newTeam} onChange={(e) => setNewTeam(e.target.value)} className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-tempo-blue outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1">{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select>
                            <select value={newRole} onChange={(e) => setNewRole(e.target.value)} title="Team Role (Member/Manager)" className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-tempo-blue outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1"><option value="Member">Member</option><option value="Owner">Team Manager</option></select>
                            <select value={newSystemRole} onChange={(e) => setNewSystemRole(e.target.value)} title="App Access (User/Admin)" className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-tempo-blue outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1"><option value="user">App User</option><option value="admin">App Admin</option></select>
                            <button type="submit" className="tempo-btn px-6 py-2 font-medium">Add</button>
                        </form>
                    </div>

                    {/* Collapsible Unassigned List */}
                    {displayUnassigned.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm transition-colors">
                            <button 
                                onClick={() => setUnassignedExpanded(!unassignedExpanded)}
                                className="w-full p-4 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                            >
                                <h3 className="font-bold text-gray-800 dark:text-gray-100 flex items-center">
                                    Unassigned / Discovered 
                                    <span className="ml-2 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full">{displayUnassigned.length}</span>
                                </h3>
                                <Icon name="ChevronLeft" className={`w-5 h-5 text-gray-500 transition-transform ${unassignedExpanded ? 'rotate-90' : '-rotate-90'}`} />
                            </button>
                            {unassignedExpanded && (
                                <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {displayUnassigned.map(m => {
                                        const email = m.email || m.id;
                                        return (
                                            <div key={email} className="flex flex-col sm:flex-row items-center gap-2 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors border border-gray-100 dark:border-gray-600">
                                                <div className="flex items-center space-x-3 flex-1 w-full"><UserAvatar user={m} size="xs" /><div className="truncate"><p className="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">{m.name || email}</p><p className="text-[10px] text-gray-500 dark:text-gray-400 truncate">{email}</p></div></div>
                                                <div className="flex gap-1.5 w-full sm:w-auto items-center flex-wrap sm:flex-nowrap mt-2 sm:mt-0">
                                                    <select value={m.team || ''} onChange={(e) => onUpdateMember(email, { team: e.target.value })} title="Team" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1.5 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-tempo-blue w-1/2 sm:w-auto min-w-[90px]"><option value="">Select Team</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}<option value="">Unassigned</option></select>
                                                    <select value={m.role || 'Member'} onChange={(e) => onUpdateMember(email, { role: e.target.value })} title="Team Role" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1.5 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-tempo-blue w-1/2 sm:w-auto"><option value="Member">Member</option><option value="Owner">Manager</option></select>
                                                    <select value={m.system_role || 'user'} onChange={(e) => onUpdateMember(email, { system_role: e.target.value })} title="App Access Role" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1.5 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-tempo-blue w-1/2 sm:w-auto"><option value="user">User</option><option value="admin">Admin</option></select>
                                                    <button onClick={() => handleRemoveTeamMember(email)} className="text-gray-400 dark:text-gray-500 hover:text-tempo-red dark:hover:text-red-400 p-1.5 bg-gray-50 dark:bg-gray-700 rounded ml-auto" title="Remove User"><Icon name="Trash2" className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {DEPARTMENTS.map(team => {
                            const members = teamMembers.filter(m => m.team === team);
                            const owners = teamMembers.filter(m => (m.team === team && m.role === 'Owner') || (m.team === 'Managers' && m.managed_teams && m.managed_teams.includes(team)));
                            const regularMembers = members.filter(m => m.role !== 'Owner');

                            return (
                                <div key={team} className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm flex flex-col transition-colors">
                                    <div className="p-4 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"><h3 className="font-bold text-gray-800 dark:text-gray-100 flex items-center"><Icon name="Briefcase" className="w-4 h-4 mr-2 text-tempo-blue" />{team}</h3><span className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full">{members.length}</span></div>
                                    <div className="p-4 space-y-4 flex-1">
                                        {owners.length > 0 && (
                                            <div className="mb-4"><h4 className="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 flex items-center"><Icon name="Crown" className="w-3 h-3 mr-1 text-tempo-yellow" />Team Owner</h4><div className="space-y-2">
                                                {owners.map(o => (
                                                    <div key={o.email} className="flex flex-col items-start gap-2 bg-tempo-yellow/10 dark:bg-tempo-yellow/20 p-2 rounded-lg border border-tempo-yellow/30 dark:border-yellow-800/50">
                                                        <div className="flex items-center space-x-2 w-full"><UserAvatar user={o} size="sm" /><div className="truncate flex-1"><p className="text-sm font-semibold text-gray-900 dark:text-gray-200 truncate">{o.name}</p><div className="flex items-center gap-1"><p className="text-xs text-gray-500 dark:text-gray-400 truncate">{o.email}</p>{o.system_role === 'admin' && <Icon name="Shield" className="w-3 h-3 text-tempo-blue dark:text-blue-400" title="Admin User"/>}</div></div></div>
                                                        {o.team === team ? (
                                                            <div className="flex gap-1 w-full"><select value={o.team || ''} onChange={(e) => onUpdateMember(o.email, { team: e.target.value })} title="Team" className="text-[10px] border border-tempo-yellow/40 dark:border-yellow-700 rounded p-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none w-1/2">{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}<option value="">Unassigned</option></select><select value={o.role || 'Member'} onChange={(e) => onUpdateMember(o.email, { role: e.target.value })} title="Team Role" className="text-[10px] border border-tempo-yellow/40 dark:border-yellow-700 rounded p-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none w-1/2"><option value="Member">Member</option><option value="Owner">Manager</option></select></div>
                                                        ) : <span className="text-[10px] bg-tempo-blue/10 text-tempo-blue dark:text-blue-400 px-1 rounded">Via Managers</span>}
                                                    </div>
                                                ))}
                                            </div></div>
                                        )}
                                        <div><h4 className="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">Members</h4><div className="space-y-2">
                                            {regularMembers.length === 0 ? <p className="text-sm text-gray-400 dark:text-gray-500 italic">No members yet.</p> : regularMembers.map(m => (
                                                <div key={m.email} className="flex flex-col gap-2 p-1.5 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors border border-transparent hover:border-gray-100 dark:hover:border-gray-600">
                                                    <div className="flex items-center space-x-2 w-full"><UserAvatar user={m} size="xs" /><div className="truncate flex-1"><p className="text-sm text-gray-800 dark:text-gray-200 truncate">{m.name}</p><div className="flex items-center gap-1"><p className="text-[10px] text-gray-500 dark:text-gray-400 truncate">{m.email}</p>{m.system_role === 'admin' && <Icon name="Shield" className="w-3 h-3 text-tempo-blue dark:text-blue-400" title="Admin User"/>}</div></div><button onClick={() => handleRemoveTeamMember(m.email)} className="text-gray-400 dark:text-gray-500 hover:text-tempo-red dark:hover:text-red-400 p-1" title="Remove"><Icon name="Trash2" className="w-3 h-3" /></button></div>
                                                    <div className="flex gap-1 w-full"><select value={m.team || ''} onChange={(e) => onUpdateMember(m.email, { team: e.target.value })} title="Team" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none w-1/3"><option value="">Unassigned</option>{DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}</select><select value={m.role || 'Member'} onChange={(e) => onUpdateMember(m.email, { role: e.target.value })} title="Team Role" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none w-1/3"><option value="Member">Member</option><option value="Owner">Manager</option></select><select value={m.system_role || 'user'} onChange={(e) => onUpdateMember(m.email, { system_role: e.target.value })} title="App Access Role" className="text-[10px] border-gray-200 dark:border-gray-600 rounded p-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none w-1/3"><option value="user">User</option><option value="admin">Admin</option></select></div>
                                                    {m.team === 'Managers' && (<div className="w-full pt-1 border-t border-gray-100 dark:border-gray-700 mt-1"><p className="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-1">Manages:</p><div className="flex flex-wrap gap-1 mb-1">{(m.managed_teams || []).map(mt => (<span key={mt} className="text-[9px] bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-400 border border-tempo-blue/20 dark:border-blue-800 px-1 rounded flex items-center">{mt}<button onClick={() => handleRemoveManagedTeam(m.email, m.managed_teams, mt)} className="ml-1 hover:text-tempo-red dark:hover:text-red-400"></button></span>))}</div><select value="" onChange={(e) => handleAddManagedTeam(m.email, m.managed_teams || [], e.target.value)} className="text-[10px] w-full border border-gray-200 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white"><option value="">+ Add Team</option>{DEPARTMENTS.filter(d => d !== 'Managers').map(d => <option key={d} value={d}>{d}</option>)}</select></div>)}
                                                </div>
                                            ))}
                                        </div></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TaskManager = ({ tasks, attendees, onUpdateTask, onAdd, onImport, meetingId, currentUserEmail, teamMembers, currentUser, onDelete, onUpdateText, onRestore }) => {
            const [newTaskText, setNewTaskText] = useState('');
            const [assignee, setAssignee] = useState(currentUserEmail || '');
            const [startDate, setStartDate] = useState(getTodayISO());
            const [endDate, setEndDate] = useState(getTodayISO());

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newTaskText.trim()) return;
                const finalAssignee = assignee || currentUserEmail; 
                onAdd(meetingId, newTaskText, finalAssignee, startDate, endDate);
                setNewTaskText('');
            };

            const handleStatusChange = (taskId, newStatus) => {
                onUpdateTask(taskId, { status: newStatus, done: newStatus === 'completed' });
            };

            const handleObstacleChange = (taskId, newObstacles) => {
                onUpdateTask(taskId, { obstacles: newObstacles });
            };

            const handleDateChange = (taskId, newDate) => {
                onUpdateTask(taskId, { end_date: newDate });
            };

            const activeTasks = tasks.filter(t => (t.status !== 'completed' && !t.done) && !t.deleted);
            const completedTasks = tasks.filter(t => (t.status === 'completed' || t.done) && !t.deleted);
            const trashTasks = tasks.filter(t => t.deleted);

            return (
                <div className="flex flex-col h-full bg-white dark:bg-gray-800 w-full transition-colors">
                    <div className="p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center"><Icon name="CheckSquare" className="w-6 h-6 mr-3 text-tempo-blue" /> Action Items</h2>
                        <form onSubmit={handleAdd} className="mt-4 flex flex-col gap-2">
                            <input type="text" placeholder="New task description..." className="w-full text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg shadow-sm focus:border-tempo-blue focus:ring-tempo-blue border p-2" value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} />
                            <div className="flex gap-2">
                                <div className="w-1/3">
                                    <select className="w-full text-sm border-gray-300 dark:border-gray-600 rounded-lg shadow-sm border p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value={assignee} onChange={(e) => setAssignee(e.target.value)}>
                                        <option value={currentUserEmail}>Me</option>
                                        {attendees.filter(u => u.email !== currentUserEmail).map(u => (
                                            <option key={u.email} value={u.email}>{u.name || u.email}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex-1 flex gap-2">
                                    <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-1/2 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2 rounded" title="Start Date"/>
                                    <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-1/2 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2 rounded" title="Due Date"/>
                                </div>
                                <button type="submit" disabled={!newTaskText.trim()} className="tempo-btn p-2 disabled:opacity-50"><Icon name="Plus" className="w-5 h-5" /></button>
                            </div>
                        </form>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-[#f4f7f9] dark:bg-gray-900/50">
                        <div className="space-y-3">
                            <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">To Do</h3>
                            {activeTasks.length === 0 && <p className="text-sm text-gray-400 dark:text-gray-500 italic">No open tasks.</p>}
                            {activeTasks.map(task => {
                                const user = attendees.find(u => u.email === task.assignee || u.id === task.assignee) || { name: 'Unknown' };
                                task.assigneeName = user.name || user.email; 
                                return <TaskCard key={task.id} task={task} meetingTitle="" onStatusChange={handleStatusChange} onObstacleChange={handleObstacleChange} onDateChange={handleDateChange} currentUser={currentUser} onDelete={onDelete} onUpdateText={onUpdateText} onRestore={onRestore} isTrash={task.deleted} />;
                            })}
                        </div>
                        {completedTasks.length > 0 && (
                            <div className="space-y-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Completed</h3>
                                {completedTasks.map(task => {
                                    const user = attendees.find(u => u.email === task.assignee || u.id === task.assignee) || { name: 'Unknown' };
                                    task.assigneeName = user.name || user.email;
                                    return <TaskCard key={task.id} task={task} meetingTitle="" onStatusChange={handleStatusChange} onObstacleChange={handleObstacleChange} onDateChange={handleDateChange} currentUser={currentUser} onDelete={onDelete} onUpdateText={onUpdateText} onRestore={onRestore} isTrash={task.deleted} />;
                                })}
                            </div>
                        )}
                        {trashTasks.length > 0 && (
                            <div className="space-y-3 pt-6 border-t border-gray-200 dark:border-gray-700 opacity-80">
                                <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3 flex items-center"><Icon name="Trash2" className="w-3 h-3 mr-1" /> Trash</h3>
                                {trashTasks.map(task => {
                                    const user = attendees.find(u => u.email === task.assignee || u.id === task.assignee) || { name: 'Unknown' };
                                    task.assigneeName = user.name || user.email;
                                    return <TaskCard key={task.id} task={task} meetingTitle="" onStatusChange={handleStatusChange} onObstacleChange={handleObstacleChange} onDateChange={handleDateChange} currentUser={currentUser} onDelete={onDelete} onUpdateText={onUpdateText} onRestore={onRestore} isTrash={true} />;
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onEmailLogin, onPasswordLogin, onSignUp, onPasswordReset }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authMethod, setAuthMethod] = useState('password'); 
            const [isSignUp, setIsSignUp] = useState(false); 
            const [isForgot, setIsForgot] = useState(false); 
            const [magicSent, setMagicSent] = useState(false);

            const handleMagicLink = (e) => {
                e.preventDefault();
                if(!email) return;
                onEmailLogin(email);
                setMagicSent(true);
            };

            const handlePasswordAction = (e) => {
                e.preventDefault();
                if (!email) return;
                if (isForgot) { onPasswordReset(email); setIsForgot(false); return; }
                if (isSignUp) { onSignUp(email, password); } else { onPasswordLogin(email, password); }
            };

            return (
                <div className="h-full flex items-center justify-center bg-tempo-ice dark:bg-gray-900 p-4 transition-colors duration-200">
                    <div className="bg-white dark:bg-gray-800 p-10 rounded-3xl shadow-2xl max-w-md w-full text-center border border-transparent dark:border-gray-700">
                        
                        {/* Decorative Trio of Accents mirroring the image's weights */}
                        <div className="flex justify-center gap-3 mb-6">
                            <div className="w-8 h-8 rounded-full bg-tempo-yellow shadow-inner"></div>
                            <div className="w-8 h-8 rounded-full bg-tempo-red shadow-inner"></div>
                            <div className="w-8 h-8 rounded-full bg-tempo-blue shadow-inner"></div>
                        </div>

                        <h1 className="text-3xl font-bold tracking-[0.2em] text-tempo-logo dark:text-white mb-2 select-none">TEMPO</h1>
                        <p className="text-gray-500 dark:text-gray-400 mb-8 font-medium">Workspace Collaboration</p>
                        
                        <button onClick={onLogin} className="w-full flex items-center justify-center space-x-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-white font-medium py-3 px-4 rounded-full transition-colors mb-6 shadow-sm"><Icon name="Google" className="w-5 h-5" /><span>Sign in with Google</span></button>
                        
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200 dark:border-gray-700"></div></div><div className="relative flex justify-center text-sm"><span className="px-3 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or email</span></div></div>
                        
                        <div className="flex justify-center space-x-6 mb-6 text-sm">
                            <button onClick={() => setAuthMethod('password')} className={`pb-1 border-b-2 transition-colors ${authMethod === 'password' ? 'border-tempo-blue text-tempo-blue font-bold' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium'}`}>Password</button>
                            <button onClick={() => setAuthMethod('magic')} className={`pb-1 border-b-2 transition-colors ${authMethod === 'magic' ? 'border-tempo-blue text-tempo-blue font-bold' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium'}`}>Magic Link</button>
                        </div>

                        {authMethod === 'magic' ? ( !magicSent ? (
                            <form onSubmit={handleMagicLink} className="space-y-4 text-left"><div><label className="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Email Address</label><input type="email" placeholder="name@example.com" className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue focus:outline-none mt-1" value={email} onChange={(e) => setEmail(e.target.value)} required/></div><button type="submit" className="tempo-btn w-full py-2.5 px-4 flex items-center justify-center space-x-2 font-medium"><Icon name="Mail" className="w-4 h-4" /><span>Send Magic Link</span></button></form>
                        ) : (<div className="mb-6 bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-400 p-4 rounded-lg text-sm border border-tempo-blue/20 dark:border-blue-800 font-medium">Check your email for the login link!</div>) ) : (
                            <form onSubmit={handlePasswordAction} className="space-y-4 text-left"><div><label className="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Email Address</label><input type="email" placeholder="name@example.com" className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue focus:outline-none mt-1" value={email} onChange={(e) => setEmail(e.target.value)} required/></div>{!isForgot && (<div><label className="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Password</label><input type="password" placeholder="" className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue focus:outline-none mt-1" value={password} onChange={(e) => setPassword(e.target.value)} required/></div>)}<button type="submit" className="tempo-btn w-full py-2.5 px-4 flex items-center justify-center space-x-2 font-medium">{isForgot ? 'Send Reset Link' : (isSignUp ? 'Create Account' : 'Sign In')}</button><div className="flex justify-between text-xs mt-4 font-medium">{!isForgot && (<button type="button" onClick={() => setIsSignUp(!isSignUp)} className="text-tempo-blue hover:underline">{isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}</button>)}<button type="button" onClick={() => setIsForgot(!isForgot)} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">{isForgot ? 'Back to Login' : 'Forgot Password?'}</button></div></form>
                        )}
                        <div className="mt-8 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl text-left"><h4 className="text-xs font-bold text-gray-700 dark:text-gray-300 mb-1 flex items-center"><Icon name="AlertCircle" className="w-3 h-3 mr-1" />Trouble Signing In?</h4><p className="text-xs text-gray-500 dark:text-gray-400 mb-2"><strong>Google Error?</strong> Verify your Redirect URL in Google Cloud matches exactly:</p><code className="block bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 p-2 rounded shadow-inner text-[10px] break-all font-mono mb-1">{window.location.href}</code></div>
                    </div>
                </div>
            );
        };

        const PasswordResetScreen = ({ onReset }) => {
            const [newPassword, setNewPassword] = useState('');
            const [message, setMessage] = useState('');
            const handleReset = (e) => { e.preventDefault(); onReset(newPassword); setMessage('Password updated! Redirecting...'); };
            return (
                <div className="h-full flex items-center justify-center bg-tempo-ice dark:bg-gray-900 p-4 transition-colors duration-200"><div className="bg-white dark:bg-gray-800 p-10 rounded-3xl shadow-2xl max-w-md w-full text-center border border-transparent dark:border-gray-700"><h1 className="text-3xl font-bold tracking-[0.2em] text-tempo-logo dark:text-white mb-2">TEMPO</h1><p className="text-gray-500 dark:text-gray-400 mb-8 font-medium">Set your new password below.</p><form onSubmit={handleReset} className="space-y-4"><input type="password" placeholder="New Password" className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-tempo-blue focus:outline-none" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} required minLength="6"/><button type="submit" className="tempo-btn w-full py-2.5 px-4 font-medium">Update Password</button></form>{message && <p className="mt-4 text-green-600 dark:text-green-400 text-sm font-medium">{message}</p>}</div></div>
            );
        };

        const App = () => {
            const [session, setSession] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [dashboardViewMode, setDashboardViewMode] = useState('meetings'); 
            const [selectedDate, setSelectedDate] = useState(getTodayISO());
            const [selectedMeetingId, setSelectedMeetingId] = useState(null);
            const [syncRange, setSyncRange] = useState('upcoming'); 
            const [taskFilter, setTaskFilter] = useState('pending'); // Default to pending 
            const [taskScope, setTaskScope] = useState('me'); 
            const [meetingScope, setMeetingScope] = useState('me'); // Added Meeting Scope
            const [showQuickAdd, setShowQuickAdd] = useState(false); 
            const [showPast, setShowPast] = useState(false); // New state for toggling past meetings
            const [lastSynced, setLastSynced] = useState(null);
            
            const [toast, setToast] = useState(null);
            const [dialogConfig, setDialogConfig] = useState(null);

            // Dark Mode State & Effect
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const stored = localStorage.getItem('tempoTheme');
                if (stored) return stored === 'dark';
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            });

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('tempoTheme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('tempoTheme', 'light');
                }
            }, [isDarkMode]);

            const toggleDarkMode = () => setIsDarkMode(!isDarkMode);

            const [meetings, setMeetings] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [teamMembers, setTeamMembers] = useState([]);
            const [colleagues, setColleagues] = useState([]);

            const [dbStatus, setDbStatus] = useState('connecting'); 
            const [errorMsg, setErrorMsg] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [supabaseClient, setSupabaseClient] = useState(null);

            // --- NOTIFICATION BUFFERS ---
            const assignmentBuffer = useRef([]);
            const completionBuffer = useRef([]);
            const assignmentTimeout = useRef(null);
            const completionTimeout = useRef(null);
            const toastTimeout = useRef(null);
            const fetchTimeoutRef = useRef(null);

            const showToast = useCallback((message, onUndo) => {
                if (toastTimeout.current) clearTimeout(toastTimeout.current);
                const id = Date.now();
                setToast({ id, message, onUndo });
                toastTimeout.current = setTimeout(() => {
                    setToast(null);
                }, 5000);
            }, []);

            // --- UNIFIED ASSIGNEE MAPPING ---
            // This safely maps the legacy user IDs (UUID) to the team_members email
            // guaranteeing 1 clean object per user, regardless of how they are assigned.
            const allPossibleAssignees = useMemo(() => {
                const uniqueByEmail = new Map();
                
                // 1. Team Members (Base truth)
                teamMembers.forEach(tm => {
                    if (tm.email) uniqueByEmail.set(tm.email.toLowerCase(), { ...tm });
                });

                // 2. Colleagues (Found in meetings)
                colleagues.forEach(c => {
                    if (c.email) {
                        const key = c.email.toLowerCase();
                        if (!uniqueByEmail.has(key)) uniqueByEmail.set(key, { ...c });
                    }
                });

                // 3. Current User (Crucial: Merges Auth UUID into the email object so legacy tasks resolve properly)
                if (currentUser && currentUser.email) {
                    const key = currentUser.email.toLowerCase();
                    if (uniqueByEmail.has(key)) {
                        const existing = uniqueByEmail.get(key);
                        existing.id = currentUser.id; // Store UUID for reverse-lookup compatibility
                        existing.name = currentUser.name || existing.name;
                        uniqueByEmail.set(key, existing);
                    } else {
                        uniqueByEmail.set(key, { ...currentUser });
                    }
                }

                return Array.from(uniqueByEmail.values());
            }, [teamMembers, colleagues, currentUser]);


            useEffect(() => {
                if (window.supabase) {
                    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    setSupabaseClient(client);
                }
            }, []);

            // Deep Linking for Meetings
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const mId = params.get('meetingId');
                if (mId && meetings.length > 0) {
                    const target = meetings.find(m => m.id === mId);
                    if (target) {
                        setSelectedMeetingId(mId);
                        setView('meeting');
                        // Clean URL without reload
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            }, [meetings]);

            // Helper to ensure we use the state client
            const client = supabaseClient; 

            // -- DEBOUNCED FETCH FOR REALTIME SPAM PREVENTION --
            const triggerBackgroundFetch = useCallback(() => {
                if (fetchTimeoutRef.current) clearTimeout(fetchTimeoutRef.current);
                fetchTimeoutRef.current = setTimeout(() => {
                    fetchData(supabaseClient, true);
                }, 2000); // 2 second debounce for realtime event bursts
            }, [supabaseClient]);

            useEffect(() => {
                if (!supabaseClient) { 
                    if(window.supabase) setLoading(false); 
                    return; 
                }

                const getSystemRole = (email) => ADMIN_EMAILS.includes(email) ? 'admin' : 'user';

                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) {
                        const role = getSystemRole(session.user.email);
                        setCurrentUser({ id: session.user.id, name: session.user.user_metadata.full_name || session.user.email, email: session.user.email, system_role: role, avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(), color: 'bg-indigo-600' });
                        setLoading(false);
                        fetchData(supabaseClient); 
                    } else {
                        setLoading(false);
                    }
                });

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((event, session) => {
                    setSession(session);
                    if (event === 'PASSWORD_RECOVERY') setView('reset_password');
                    if (session) {
                        const role = getSystemRole(session.user.email);
                        setCurrentUser({ id: session.user.id, name: session.user.user_metadata.full_name || session.user.email, email: session.user.email, system_role: role, avatar: (session.user.user_metadata.full_name || 'U').substring(0, 2).toUpperCase(), color: 'bg-indigo-600' });
                        
                        // Prevent fetching loop by ensuring it's an actionable startup/auth event
                        if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN') {
                            fetchData(supabaseClient);
                        }
                    } else {
                        setCurrentUser(null); setMeetings([]); setTasks([]); setTeamMembers([]); setView('dashboard');
                    }
                });
                return () => subscription.unsubscribe();
            }, [supabaseClient]);

            // -- EMAIL QUEUE HELPER --
            const queueEmail = async (to, subject, body) => {
                if (!client || dbStatus !== 'connected' || !to) return;
                await client.from('pending_emails').insert({
                    recipient_email: to,
                    subject: subject,
                    body: body,
                    status: 'pending'
                });
            };

            // --- BATCH NOTIFICATION LOGIC ---
            
            // 1. Flush Assignments (Group by Assignee -> Meeting)
            const flushAssignmentNotifications = useCallback(async () => {
                if (assignmentBuffer.current.length === 0) return;
                const tasksToProcess = [...assignmentBuffer.current];
                assignmentBuffer.current = []; // Clear buffer

                // Group by Assignee Email
                const tasksByAssignee = {};
                for (const item of tasksToProcess) {
                    const { task, meetingTitle, meetingId } = item;
                    const assigneeId = task.assignee;
                    if (!assigneeId || assigneeId === currentUser?.id || assigneeId === currentUser?.email) continue; // Skip self

                    const user = allPossibleAssignees.find(u => u.email === assigneeId || u.id === assigneeId);
                    const email = user ? user.email : (assigneeId.includes('@') ? assigneeId : null);
                    
                    if (email) {
                        if (!tasksByAssignee[email]) tasksByAssignee[email] = [];
                        tasksByAssignee[email].push({ ...task, meetingTitle, meetingId, assigneeName: user ? user.name : 'there' });
                    }
                }

                // Send Emails
                for (const [email, tasks] of Object.entries(tasksByAssignee)) {
                    const name = tasks[0].assigneeName;
                    const count = tasks.length;
                    
                    // Group by meeting inside the email if needed
                    const meetingsMap = {};
                    tasks.forEach(t => {
                        const mId = t.meetingId || 'standalone';
                        if(!meetingsMap[mId]) meetingsMap[mId] = { title: t.meetingTitle || 'Personal Tasks', tasks: [] };
                        meetingsMap[mId].tasks.push(t);
                    });

                    let body = `Hi ${name},\n\nYou have ${count} new action item(s):\n\n`;
                    
                    Object.entries(meetingsMap).forEach(([mId, data]) => {
                        body += `--- ${data.title} ---\n`;
                        data.tasks.forEach(t => {
                            body += `[ ] ${t.text} (Due: ${t.end_date || 'No Date'})\n`;
                        });
                        // Add Link
                        const link = `${window.location.origin}${window.location.pathname}?meetingId=${mId}`;
                        body += `View Meeting: ${link}\n\n`;
                    });
                    
                    body += `\n- TEMPO`;
                    
                    const subject = count === 1 
                        ? `New Action Item: ${tasks[0].text.substring(0,30)}...` 
                        : `You have ${count} new action items`;

                    await queueEmail(email, subject, body);
                }
            }, [client, allPossibleAssignees, currentUser]);

            // 2. Flush Completions (Group by Manager AND Assigner)
            const flushCompletionNotifications = useCallback(async () => {
                if (completionBuffer.current.length === 0) return;
                const tasksToProcess = [...completionBuffer.current];
                completionBuffer.current = [];

                // Find manager for each task assignee and group
                const notificationsByEmail = {};

                for (const item of tasksToProcess) {
                    const { task, meetingTitle } = item;
                    const assigneeId = task.assignee;
                    const assignerId = task.assigner;
                    const assigneeUser = allPossibleAssignees.find(m => m.email === assigneeId || m.id === assigneeId);

                    // 1. Notify Manager
                    if (assigneeUser && assigneeUser.team) {
                        const manager = allPossibleAssignees.find(m => (m.team === assigneeUser.team && m.role === 'Owner') || (m.managed_teams && m.managed_teams.includes(assigneeUser.team)));
                        if (manager && manager.email) {
                            if (!notificationsByEmail[manager.email]) notificationsByEmail[manager.email] = { name: manager.name, items: [], type: 'manager' };
                            notificationsByEmail[manager.email].items.push({ task, doer: assigneeUser.name, meetingTitle });
                        }
                    }

                    // 2. Notify Assigner (if different from manager and not self)
                    if (assignerId && assignerId !== assigneeId) {
                        const assignerUser = allPossibleAssignees.find(m => m.email === assignerId || m.id === assignerId);
                        const assignerEmail = assignerUser ? assignerUser.email : (assignerId.includes('@') ? assignerId : null);
                        
                        if (assignerEmail && !notificationsByEmail[assignerEmail]) { // Don't duplicate if assigner IS manager
                             if (!notificationsByEmail[assignerEmail]) notificationsByEmail[assignerEmail] = { name: assignerUser?.name || 'Assigner', items: [], type: 'assigner' };
                             notificationsByEmail[assignerEmail].items.push({ task, doer: assigneeUser?.name || 'Assignee', meetingTitle });
                        } else if (assignerEmail && notificationsByEmail[assignerEmail]) {
                             const exists = notificationsByEmail[assignerEmail].items.some(i => i.task.id === task.id);
                             if(!exists) notificationsByEmail[assignerEmail].items.push({ task, doer: assigneeUser?.name || 'Assignee', meetingTitle });
                        }
                    }
                }

                // Send Emails
                for (const [email, data] of Object.entries(notificationsByEmail)) {
                    const count = data.items.length;
                    let body = `Hi ${data.name},\n\n${count} action item(s) have been marked complete:\n\n`;
                    
                    data.items.forEach(i => {
                        body += ` ${i.doer} completed: "${i.task.text}" (${i.meetingTitle})\n`;
                    });
                    
                    const link = `${window.location.origin}${window.location.pathname}`;
                    body += `\nView Dashboard: ${link}\n\n- TEMPO`;

                    await queueEmail(email, `Update: ${count} Task(s) Completed`, body);
                }
            }, [client, allPossibleAssignees]);


            // -- TRIGGERS --

            // Trigger for New Tasks (Buffered)
            const scheduleAssignmentNotification = (task, meetingTitle, meetingId) => {
                assignmentBuffer.current.push({ task, meetingTitle, meetingId });
                if (assignmentTimeout.current) clearTimeout(assignmentTimeout.current);
                // Wait 10 seconds to collect batch
                assignmentTimeout.current = setTimeout(flushAssignmentNotifications, 10000); 
            };

            // Trigger for Completed Tasks (Buffered)
            const scheduleCompletionNotification = (task, meetingTitle) => {
                completionBuffer.current.push({ task, meetingTitle });
                if (completionTimeout.current) clearTimeout(completionTimeout.current);
                // Wait 60 seconds to collect multiple check-offs
                completionTimeout.current = setTimeout(flushCompletionNotifications, 60000);
            };

            // Immediate reminder (keep this separate as it's urgent)
            const checkAndSendReminders = async (currentTasks, allAssignees) => {
                if (!client) return;
                const today = new Date();
                today.setHours(0,0,0,0);
                const twoDaysFromNow = new Date(today);
                twoDaysFromNow.setDate(today.getDate() + 2);
                
                const tasksDueSoon = currentTasks.filter(t => {
                    if (!t.end_date) return false;
                    const due = new Date(t.end_date);
                    due.setHours(0,0,0,0);
                    return due <= twoDaysFromNow && due >= today && 
                           !t.done && t.status !== 'completed' &&
                           t.reminder_sent !== true && !t.deleted; // Check deleted flag
                });

                if (tasksDueSoon.length > 0) {
                    for (const task of tasksDueSoon) {
                        const assigneeId = task.assignee;
                        if (!assigneeId) continue;
                        const user = allAssignees.find(u => u.email === assigneeId || u.id === assigneeId);
                        const email = user ? user.email : (assigneeId.includes('@') ? assigneeId : null);
                        const name = user ? user.name : "there";
                        if (email) {
                            await queueEmail(email, `Reminder: Task Due Soon`, `Hi ${name},\n\nJust a reminder that the task "${task.text}" is due on ${task.end_date}.\n\n- TEMPO`);
                            await client.from('tasks').update({ reminder_sent: true }).eq('id', task.id);
                        }
                    }
                }
            };

            const fetchData = async (sbClient = client, isBackground = false) => {
                if (!sbClient) return;
                if (!isBackground) setDbStatus('connecting');
                try {
                    const { error: checkError } = await sbClient.from('meetings').select('id').limit(1);
                    if (checkError && (checkError.code === 'PGRST205' || checkError.code === '42P01')) throw { code: 'TABLE_MISSING' };

                    // Fetch large range to prevent truncation of new items
                    const { data: m, error: mErr } = await sbClient.from('meetings').select('*').range(0, 9999);
                    const { data: t, error: tErr } = await sbClient.from('tasks').select('*').range(0, 9999);
                    const { data: tm, error: tmErr } = await sbClient.from('team_members').select('*');

                    if (mErr) console.error("Meetings Fetch Error:", mErr);
                    if (tErr) console.error("Tasks Fetch Error:", tErr);

                    if (mErr || tErr) throw new Error(`Fetch failed: ${mErr?.message || tErr?.message || 'Unknown network/DB error'}`);

                    const parsedM = m.map(x => ({ ...x, participants: typeof x.participants === 'string' ? JSON.parse(x.participants) : x.participants || [] }));
                    const parsedT = t.map(x => ({ ...x, meetingId: x.meeting_id }));
                    const parsedTeam = tm || [];
                    
                    setTeamMembers(parsedTeam);
                    const uniqueColleaguesMap = new Map();
                    parsedTeam.forEach(member => uniqueColleaguesMap.set(member.email, member));
                    parsedM.forEach(meet => { if (Array.isArray(meet.participants)) meet.participants.forEach(p => { const key = p.email || p.id || p.name; if (key && !uniqueColleaguesMap.has(key)) uniqueColleaguesMap.set(key, p); }); });
                    const colleaguesList = Array.from(uniqueColleaguesMap.values());
                    setColleagues(colleaguesList);
                    setMeetings(parsedM); setTasks(parsedT); setDbStatus(parsedM.length ? 'connected' : 'empty');

                    // Note: checkAndSendReminders is safe here, but it triggers after allPossibleAssignees runs its first pass.
                    // To be safe we pass it raw, but unified mapping logic in allPossibleAssignees handles it cleanly.
                    checkAndSendReminders(parsedT, [...parsedTeam, ...colleaguesList, ...(currentUser ? [currentUser] : [])]);
                } catch (err) {
                    if (err.code === 'TABLE_MISSING') setDbStatus('setup_required'); else { console.error("fetchData caught error:", err); setDbStatus('error'); setErrorMsg(err.message); }
                }
            };

            const userId = session?.user?.id;
            useEffect(() => {
                if (!supabaseClient || !userId) return;

                const channel = supabaseClient.channel('realtime_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'meetings' }, triggerBackgroundFetch)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, triggerBackgroundFetch)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'team_members' }, triggerBackgroundFetch)
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(channel);
                };
            }, [supabaseClient, userId, triggerBackgroundFetch]);

            const handleSync = async () => {
                if (!session?.provider_token) { showToast("Sync Unavailable: Missing Google Access Token. Please re-login."); return; }
                setIsSyncing(true);
                
                try {
                    // Start sync from 5 YEARS AGO to ensure retrievable history as requested
                    let timeMin = new Date();
                    timeMin.setFullYear(timeMin.getFullYear() - 5); 
                    timeMin.setHours(0,0,0,0);
                    
                    const timeMinIso = timeMin.toISOString();
                    const dateMinStr = timeMinIso.split('T')[0]; 

                    const cacheBuster = new Date().getTime();
                    
                    console.log(`Syncing events from ${timeMinIso}...`);

                    const resp = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=2500&orderBy=startTime&singleEvents=true&timeMin=${timeMinIso}&_=${cacheBuster}`, { 
                        headers: { 
                            Authorization: `Bearer ${session.provider_token}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate'
                        } 
                    });
                    
                    if (resp.status === 401) {
                        showToast("Google Authentication Expired. Please log out and sign in again.");
                        throw new Error("Token expired");
                    }

                    if (!resp.ok) throw new Error("Failed to fetch from Google");
                    const data = await resp.json();
                    
                    console.log(`Fetched ${data.items.length} events from Google.`);
                    
                    const gCalEventIds = new Set();
                    const meetingBatch = [];
                    const taskBatch = [];

                    for (const event of data.items) {
                        if (event.status === 'cancelled') continue;
                        
                        gCalEventIds.add(event.id);
                        
                        const mId = event.id;
                        const docId = `doc_${event.id}`;
                        
                        // FIX: Improved Date Handling
                        let dateStr, timeStr;
                        
                        if (event.start.date) {
                            dateStr = event.start.date;
                            timeStr = 'All Day';
                        } else {
                            const start = new Date(event.start.dateTime);
                            const offset = start.getTimezoneOffset() * 60000;
                            const localDate = new Date(start.getTime() - offset);
                            dateStr = localDate.toISOString().split('T')[0];
                            timeStr = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        }
                        
                        const description = event.description || '';
                        const taskRegex = /(?:^|\n)(?:-? ?\[ ?\]|TODO:|Task:)\s*(.+)/gi;
                        let match;
                        while ((match = taskRegex.exec(description)) !== null) {
                            const taskText = match[1].trim();
                            if (taskText) {
                                const taskId = `t_${event.id}_${taskText.substring(0, 5).replace(/\s/g, '')}`;
                                // Note: We now consistently use email for unified assignment mapping!
                                taskBatch.push({ id: taskId, meeting_id: mId, text: taskText, assignee: currentUser.email, status: 'pending', deleted: false });
                            }
                        }

                        const attendees = event.attendees ? event.attendees.map(a => ({ id: a.email, email: a.email, name: a.displayName || a.email.split('@')[0], avatar: (a.displayName || a.email).substring(0,2).toUpperCase() })) : [];
                        const safeAttendees = attendees.map(a => JSON.parse(JSON.stringify(a)));
                        
                        const userInAttendees = safeAttendees.find(a => a.email && a.email.toLowerCase() === currentUser.email.toLowerCase());
                        if (!userInAttendees) safeAttendees.push({ id: currentUser.id, email: currentUser.email, name: currentUser.name, avatar: currentUser.avatar });

                        let gDocLink = null;
                        if (event.attachments) {
                            const gDoc = event.attachments.find(a => a.mimeType === 'application/vnd.google-apps.document');
                            if (gDoc) gDocLink = gDoc.fileUrl;
                        }

                        let videoLink = event.hangoutLink;
                        if (!videoLink && event.location && (event.location.startsWith('http') || event.location.startsWith('https'))) { videoLink = event.location; }

                        if (client) {
                            meetingBatch.push({ 
                                id: mId, 
                                title: event.summary || '(No Title)', 
                                date: dateStr, 
                                time: timeStr, 
                                duration: '1h', 
                                participants: safeAttendees, 
                                doc_id: docId, 
                                google_calendar_id: event.id, 
                                synced: true, 
                                platform: 'Google Calendar', 
                                google_doc_link: gDocLink, 
                                video_link: videoLink 
                            });
                        }
                    }
                    
                    // BATCH OPS
                    if (client) {
                        if (meetingBatch.length > 0) {
                            const { error } = await client.from('meetings').upsert(meetingBatch);
                            if (error) {
                                console.error(error);
                                if (error.message.includes("row-level security")) showToast("Database Write Locked: Go to Supabase > SQL Editor and run the provided setup script.");
                                else showToast("Sync Write Error: " + error.message);
                                throw error;
                            }
                        }
                        if (taskBatch.length > 0) {
                            const { error } = await client.from('tasks').upsert(taskBatch, { ignoreDuplicates: false }); // Allow updates to flip 'deleted' back to false
                            if (error) console.error("Task sync error (non-fatal):", error);
                        }
                    }

                    // --- STALE DATA CLEANUP REMOVED COMPLETELY ---
                    // This ensures no task/meeting is ever deleted automatically during sync.

                    setMeetings([]); 
                    await fetchData(client);
                    setLastSynced(new Date().toLocaleTimeString());
                    
                } catch (e) { 
                    console.error("Sync failed:", e); 
                } finally { 
                    setIsSyncing(false); 
                }
            };

            const handleImportFromDoc = async (meeting) => {
                if (!session?.provider_token) { showToast("Missing Google Token. Please re-login."); return; }
                if (!meeting.google_doc_link) { showToast("No Google Doc linked to this meeting."); return; }
                const match = meeting.google_doc_link.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (!match) { showToast("Invalid Google Doc Link."); return; }
                const docId = match[1];
                setIsSyncing(true);
                try {
                    const resp = await fetch(`https://docs.googleapis.com/v1/documents/${docId}`, { headers: { Authorization: `Bearer ${session.provider_token}` } });
                    if (!resp.ok) { const err = await resp.json(); throw new Error(err.error?.message || "Failed to fetch Doc"); }
                    const docData = await resp.json();
                    
                    // --- HELPERS ---
                    const flattenDoc = (content) => {
                        let nodes = [];
                        if (!content) return nodes;
                        content.forEach(elem => {
                            if (elem.paragraph) {
                                nodes.push(elem.paragraph);
                            } else if (elem.table) {
                                elem.table.tableRows.forEach(row => {
                                    row.tableCells.forEach(cell => {
                                        nodes = nodes.concat(flattenDoc(cell.content));
                                    });
                                });
                            }
                        });
                        return nodes;
                    };

                    const findUserInText = (text, richTextElements) => {
                        if (richTextElements && richTextElements.length > 0) {
                            for (const el of richTextElements) {
                                if (el.person?.personProperties?.email) {
                                    const email = el.person.personProperties.email;
                                    const user = allPossibleAssignees.find(u => 
                                        (u.email && u.email.toLowerCase() === email.toLowerCase())
                                    );
                                    if (user) return user.email; 
                                    return email;
                                }
                            }
                        }
                        const lowerText = text.toLowerCase().replace(/\u00A0/g, ' ');
                        const allUsers = [...allPossibleAssignees];
                        allUsers.sort((a, b) => (b.name?.length || 0) - (a.name?.length || 0)); 
                        for (const u of allUsers) {
                            if (u.name) {
                                const name = u.name.toLowerCase();
                                if (lowerText.startsWith(name) || lowerText.startsWith('@' + name)) {
                                    return u.email || u.id;
                                }
                            }
                        }
                        return null;
                    };

                    // --- EXECUTION ---
                    const flatNodes = flattenDoc(docData.body?.content);
                    
                    // Improved Regex for Date Headers (handles 10.15.2023, 10/15, October 15, etc.)
                    const dateRegex = /\b(?:\d{4}[-\/.]\d{1,2}[-\/.]\d{1,2}|\d{1,2}[-\/.]\d{1,2}(?:[-\/.]\d{2,4})?|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s\d{1,2}(?:st|nd|rd|th)?(?:,?\s\d{2,4})?)\b/i;
                    
                    const meetingHeaders = [];
                    flatNodes.forEach((node, idx) => {
                        const txt = node.elements?.map(e => e.textRun?.content || '').join('').trim();
                        if (!txt) return;
                        
                        // Exclude lines that are clearly bullets or checkboxes from being considered date headers
                        if (node.bullet) return;
                        if (/^(\[ ?[xX]? ?\]|\( ?[xX]? ?\)|\u2610|\u2611)/i.test(txt)) return;
                        
                        const dateMatch = txt.match(dateRegex);
                        if (dateMatch && txt.length < 150) {
                            // Timezone-safe parse
                            const ts = Date.parse(dateMatch[0]);
                            if (!isNaN(ts)) {
                                const d = new Date(ts);
                                // Sanity check to avoid parsing random numbers as ancient/future dates
                                if (d.getFullYear() > 2000 && d.getFullYear() < 2100) {
                                    const offset = d.getTimezoneOffset() * 60000;
                                    const localIso = new Date(d.getTime() - offset).toISOString().split('T')[0];
                                    meetingHeaders.push({
                                        index: idx,
                                        dateStr: localIso,
                                        rawText: txt
                                    });
                                }
                            }
                        }
                    });

                    // IDENTIFY THE FIRST DATE HEADER IN THE DOCUMENT
                    let targetHeader = meetingHeaders.length > 0 ? meetingHeaders[0] : null;

                    // EXTRACT ONLY FROM THIS FIRST DATE HEADER FORWARD
                    let startIndex = targetHeader ? targetHeader.index + 1 : 0;

                    const scanNodesForTasks = (startIdx) => {
                        const results = [];
                        let inActionItems = false;
                        
                        for (let i = startIdx; i < flatNodes.length; i++) {
                            const paraNode = flatNodes[i];
                            
                            // 1. Stop processing immediately when a horizontal divider appears
                            const hasHorizontalRule = paraNode.elements?.some(e => e.horizontalRule);
                            if (hasHorizontalRule) {
                                console.log("Found horizontal divider, stopping extraction.");
                                break;
                            }
                            
                            let paraText = '';
                            let richElements = [];
                            paraNode.elements?.forEach(pElem => {
                                if (pElem.textRun) paraText += pElem.textRun.content;
                                if (pElem.person) richElements.push(pElem);
                            });
                            
                            let rawText = paraText.replace(/\u00A0/g, ' ').trim();
                            if (!rawText) continue;

                            // 2. Stop processing immediately when another date header appears
                            if (targetHeader) {
                                const thisHeader = meetingHeaders.find(h => h.index === i);
                                if (thisHeader && thisHeader.index !== targetHeader.index) {
                                    console.log("Found another date header, stopping extraction.", thisHeader.dateStr);
                                    break;
                                }
                            }

                            if (/^(attendees|participants|guests|cc|to):/i.test(rawText)) continue;

                            // Mark when we enter the "Action items" section
                            if (/^(action items|next steps|to do|tasks)(:| -)?/i.test(rawText)) {
                                inActionItems = true;
                                continue;
                            } else if (/^[a-zA-Z0-9\s]+(:| -)$/i.test(rawText) && rawText.length < 25) {
                                // Exiting action items section if we hit a new generic heading
                                inActionItems = false;
                            }

                            // 3. Only extract items listed under "Action items"
                            if (inActionItems) {
                                const manualCheckboxRegex = /^(\[ ?[xX]? ?\]|\( ?[xX]? ?\)|\u2610|\u2611|\u2714|-|\u25CF)\s*/i;
                                let cleanText = rawText.replace(manualCheckboxRegex, '').trim();

                                if (cleanText.length > 2) {
                                    const assignedTo = findUserInText(cleanText, richElements);
                                    // 4. Only extract lines that contain an assigned owner
                                    // Tasks without an assigned owner or generic commentary are naturally skipped since assignedTo is null.
                                    if (assignedTo) {
                                        const assignedUser = allPossibleAssignees.find(u => (u.id === assignedTo || u.email === assignedTo));
                                        if (assignedUser && assignedUser.name) {
                                            const escapedName = assignedUser.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                            const nameRegex = new RegExp(`^@?${escapedName}\\s*`, 'i');
                                            cleanText = cleanText.replace(nameRegex, '').trim();
                                        }
                                        
                                        cleanText = cleanText.replace(/^[:\-]\s*/, '').trim();
                                        if (cleanText) {
                                            results.push({ text: cleanText, assignee: assignedTo });
                                        }
                                    }
                                }
                            }
                        }
                        return results;
                    };

                    let tasksFound = scanNodesForTasks(startIndex);
                    
                    if (tasksFound.length === 0) { 
                        showToast(`No assigned checklist items found under the action items section for ${targetHeader ? targetHeader.dateStr : 'this meeting'}.`); 
                    } 
                    else {
                        let createdCount = 0;
                        const taskStartDate = targetHeader ? targetHeader.dateStr : (meeting.date || getTodayISO()); 
                        const existingTexts = new Set(tasks.filter(t => t.meetingId === meeting.id).map(t => t.text.trim().toLowerCase()));

                        for (const task of tasksFound) {
                             const normalizedText = task.text.trim().toLowerCase();
                             if (existingTexts.has(normalizedText)) continue;

                             const taskId = `t_doc_${Date.now()}_${Math.floor(Math.random()*10000)}`;
                             // Uses email for assigner mapping consistency
                             const newTaskObj = { id: taskId, meeting_id: meeting.id, text: task.text, assignee: task.assignee, assigner: currentUser.email, status: 'pending', start_date: taskStartDate, end_date: null, deleted: false };
                             
                             setTasks(prev => [...prev, { ...newTaskObj, meetingId: meeting.id }]); // update local
                             
                             if (client) { 
                                 await client.from('tasks').insert(newTaskObj); 
                                 // BUFFERED Notification
                                 scheduleAssignmentNotification(newTaskObj, meeting.title, meeting.id);
                             }
                             
                             existingTexts.add(normalizedText); 
                             createdCount++;
                        }
                        
                        if (createdCount === 0) {
                            showToast("No new tasks imported (duplicates skipped).");
                        } else {
                            const msgSource = targetHeader ? `section: ${targetHeader.dateStr}` : "entire doc";
                            showToast(`Imported ${createdCount} tasks from ${msgSource}!`);
                        }
                    }
                } catch (e) { console.error(e); showToast("Import failed: " + e.message); } finally { setIsSyncing(false); }
            };

            const handleAddTeamMember = async (email, name, team, role, systemRole) => {
                if (!email.endsWith('@tempo.fit')) { showToast('Invalid email domain.'); return; }
                try {
                    if (client) { const { error } = await client.from('team_members').insert({ email, name, team, role, system_role: systemRole }); if (error) throw error; }
                    await fetchData(client); showToast(`Added ${name}.`);
                } catch(e) { showToast("Error: " + e.message); }
            };
            
            const handleUpdateTeamMember = async (email, updates) => {
                setColleagues(prev => prev.map(c => (c.email === email || c.id === email) ? { ...c, ...updates } : c));
                setTeamMembers(prev => prev.map(m => m.email === email ? { ...m, ...updates } : m));
                if (dbStatus === 'connected' && client) { try { const { error } = await client.from('team_members').upsert({ email, name: (colleagues.find(c => c.email === email)?.name || email), ...updates }); if (error) throw error; } catch (e) { console.error(e); showToast("Update failed."); } }
            };

            const handleUpdateTask = async (taskId, updates) => {
                const task = tasks.find(t => t.id === taskId);
                const meeting = meetings.find(m => m.id === task?.meetingId);
                
                // Save previous state for potential undo
                const prevStatus = task?.status;
                const prevDone = task?.done;

                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, ...updates } : t));
                if (dbStatus === 'connected' && client) { 
                    await client.from('tasks').update(updates).eq('id', taskId); 
                    
                    // COMPLETION NOTIFICATION & UNDO
                    if (updates.status === 'completed' || updates.done === true) {
                        if (task && prevStatus !== 'completed' && !prevDone) {
                            scheduleCompletionNotification({ ...task, ...updates }, meeting?.title || 'Unknown Meeting');
                            showToast("Task marked as completed", () => {
                                handleUpdateTask(taskId, { status: prevStatus, done: prevDone });
                            });
                        }
                    }
                }
            };

            const handleUpdateText = async (taskId, newText) => {
                if(!newText.trim()) return;
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, text: newText } : t));
                if (dbStatus === 'connected' && client) {
                    await client.from('tasks').update({ text: newText }).eq('id', taskId);
                }
            };

            const handleAddStandaloneTask = (text, assigneeId, start, end) => {
                if (!text.trim()) return;
                const newId = `t_${Date.now()}`;
                // Now enforcing email for assignment keys
                const newTask = { id: newId, meeting_id: 'standalone', text: text, assignee: assigneeId || currentUser.email, assigner: currentUser.email, status: 'pending', start_date: start || getTodayISO(), end_date: end || getTodayISO(), deleted: false };
                
                setTasks(prev => [newTask, ...prev]);
                if (dbStatus === 'connected' && client) { 
                    client.from('tasks').insert(newTask).then(({error}) => { 
                        if(error) {
                            console.error("Task Insert Error (Personal):", error);
                            showToast("Failed to save task. Database schema might be outdated. Please run the SQL Setup script again.");
                        }
                        else scheduleAssignmentNotification(newTask, 'Personal Task', 'standalone'); // BUFFERED
                    }); 
                }
                setShowQuickAdd(false);
            };

            const handleDeleteTask = async (taskId) => {
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, deleted: true } : t));
                if (dbStatus === 'connected' && client) {
                    await client.from('tasks').update({ deleted: true }).eq('id', taskId);
                }
                showToast("Task moved to trash", () => handleRestoreTask(taskId, true));
            };

            const handleRestoreTask = async (taskId, fromUndo = false) => {
                setTasks(prev => prev.map(t => t.id === taskId ? { ...t, deleted: false } : t));
                if (dbStatus === 'connected' && client) {
                    await client.from('tasks').update({ deleted: false }).eq('id', taskId);
                }
                if (fromUndo) {
                    setToast(null);
                } else {
                    showToast("Task restored", () => handleDeleteTask(taskId));
                }
            };

            const handleDeleteAllTasks = async () => {
                setDialogConfig({
                    type: 'confirm',
                    message: " DANGER ZONE \n\nAre you sure you want to PERMANENTLY delete ALL tasks in the system? This cannot be undone.",
                    onConfirm: async () => {
                        setTasks([]);
                        if (dbStatus === 'connected' && client) {
                            const { error } = await client.from('tasks').delete().neq('id', 'placeholder');
                            if (error) {
                                console.error(error);
                                showToast("Failed to delete from database: " + error.message);
                                fetchData(client); // restore
                            } else {
                                showToast("All tasks deleted successfully.");
                            }
                        }
                    }
                });
            };
            
            // --- AUTH HANDLERS RESTORED ---
            const handleGoogleLogin = async () => { if (!client) return; const { error } = await client.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href, scopes: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/documents.readonly' } }); if (error) showToast(error.message); };
            const handleEmailLogin = async (email) => { if (!client) return; const { error } = await client.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } }); if (error) showToast(error.message); };
            const handlePasswordLogin = async (email, password) => { if (!client) return; const { error } = await client.auth.signInWithPassword({ email, password }); if (error) showToast(error.message); };
            const handleSignUp = async (email, password) => { if (!client) return; const { error } = await client.auth.signUp({ email, password, options: { data: { full_name: email.split('@')[0] } } }); if (error) showToast(error.message); else showToast("Sign up successful! Please check your email."); };
            const handlePasswordReset = async (email) => { if (!client) return; const { error } = await client.auth.resetPasswordForEmail(email, { redirectTo: window.location.href }); if (error) showToast(error.message); else showToast("Password reset email sent!"); };
            const handleUpdatePassword = async (newPassword) => { if (!client) return; const { error } = await client.auth.updateUser({ password: newPassword }); if (error) showToast(error.message); else { showToast("Password updated successfully!"); setView('dashboard'); fetchData(client); } };
            
            const handleLogout = async () => { 
                if (!client) return; 
                try { await client.auth.signOut(); } catch (error) { console.error("Sign out error:", error); } 
                finally { setSession(null); setCurrentUser(null); setMeetings([]); setTasks([]); setTeamMembers([]); setView('dashboard'); setSelectedMeetingId(null); } 
            };
            
            const handleRemoveTeamMember = async (email) => {
                setDialogConfig({
                    type: 'confirm',
                    message: `Are you sure you want to remove ${email}?`,
                    onConfirm: async () => {
                        setTeamMembers(prev => prev.filter(m => m.email !== email));
                        if (dbStatus === 'connected' && client) {
                            try { const { error } = await client.from('team_members').delete().eq('email', email); if (error) throw error; } catch (e) { console.error(e); showToast("Failed to remove member"); }
                        }
                    }
                });
            };
            // --- END AUTH HANDLERS ---

            const isManager = useMemo(() => {
                if (!currentUser) return false;
                if (currentUser.system_role === 'admin') return true;
                const memberRecord = teamMembers.find(m => m.email && m.email.toLowerCase() === (currentUser.email || '').toLowerCase());
                if (memberRecord) { if (memberRecord.role === 'Owner') return true; if (memberRecord.managed_teams && memberRecord.managed_teams.length > 0) return true; }
                return false;
            }, [currentUser, teamMembers]);

            const sortedMeetings = useMemo(() => {
                if (!currentUser) return [];
                const userEmail = (currentUser.email || '').toLowerCase().trim();
                const userId = currentUser.id;
                
                let relevantMeetings = meetings;
                if (isManager && meetingScope === 'team') {
                    const myManagedTeams = [];
                    const meInTeam = teamMembers.find(tm => tm.email && tm.email.toLowerCase() === userEmail);
                    if (meInTeam) {
                          if (meInTeam.role === 'Owner' && meInTeam.team) myManagedTeams.push(meInTeam.team);
                          if (meInTeam.managed_teams) myManagedTeams.push(...meInTeam.managed_teams);
                    }
                    
                    const teamMemberIds = teamMembers
                        .filter(tm => myManagedTeams.includes(tm.team))
                        .filter(tm => tm.email && tm.email.toLowerCase() !== userEmail)
                        .flatMap(tm => [tm.email, tm.email ? tm.email.toLowerCase() : null, tm.id])
                        .filter(Boolean);
                    
                    relevantMeetings = meetings.filter(m => {
                        const parts = m.participants || [];
                        return parts.some(p => {
                            const pId = typeof p === 'string' ? p : (p.id || p.email);
                            const pEmail = typeof p === 'object' ? p.email : p;
                            if (!pId && !pEmail) return false;
                            const pIdLower = pId ? pId.toLowerCase().trim() : '';
                            const pEmailLower = pEmail ? pEmail.toLowerCase().trim() : '';
                            return teamMemberIds.includes(pIdLower) || teamMemberIds.includes(pEmailLower);
                        });
                    });
                } else {
                    relevantMeetings = meetings.filter(m => {
                        const parts = m.participants || [];
                        return parts.some(p => {
                            if (typeof p === 'string') return p === userId || p.toLowerCase().trim() === userEmail;
                            const pId = p.id; const pEmail = p.email ? p.email.toLowerCase().trim() : '';
                            if (pId === userId) return true; if (pEmail === userEmail) return true;
                            if (typeof pId === 'string' && pId.toLowerCase().trim() === userEmail) return true;
                            return false;
                        });
                    });
                }

                // Filtering Logic Update: Handle "Show Past"
                let dateFiltered;
                if (selectedDate) {
                    dateFiltered = relevantMeetings.filter(m => m.date === selectedDate);
                } else {
                    // If showing all, filter based on showPast toggle
                    if (showPast) {
                        dateFiltered = relevantMeetings;
                    } else {
                        const today = getTodayISO();
                        dateFiltered = relevantMeetings.filter(m => m.date >= today);
                    }
                }

                return dateFiltered.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateA - dateB; 
                });
            }, [meetings, currentUser, selectedDate, meetingScope, isManager, teamMembers, showPast]);

            const filteredTasks = useMemo(() => {
                let scopeFiltered = [];
                const effectiveScope = isManager ? taskScope : (taskScope === 'assigned_by_me' ? 'assigned_by_me' : 'me');

                if (effectiveScope === 'me') {
                    const myEmail = (currentUser?.email || '').toLowerCase().trim();
                    const myId = currentUser?.id;
                    scopeFiltered = tasks.filter(t => { const assignee = (t.assignee || '').toLowerCase().trim(); return assignee === myId || assignee === myEmail; }); 
                } else if (effectiveScope === 'assigned_by_me') {
                    // Filter: Assignee is NOT me, but Assigner IS me
                    const myId = currentUser?.id;
                    const myEmail = currentUser?.email;
                    scopeFiltered = tasks.filter(t => {
                        const assigner = t.assigner || '';
                        const assignee = t.assignee || '';
                        const isAssignedByMe = assigner === myId || assigner === myEmail;
                        const isAssignedToMe = assignee === myId || assignee === myEmail;
                        return isAssignedByMe && !isAssignedToMe;
                    });
                } else if (effectiveScope === 'team') {
                    const myManagedTeams = [];
                    const userEmail = (currentUser?.email || '').toLowerCase();
                    const meInTeam = teamMembers.find(tm => tm.email && tm.email.toLowerCase() === userEmail);
                    if (meInTeam) {
                        if (meInTeam.role === 'Owner' && meInTeam.team) myManagedTeams.push(meInTeam.team);
                        if (meInTeam.managed_teams) myManagedTeams.push(...meInTeam.managed_teams);
                    }
                    
                    const teamMemberIdentifiers = teamMembers
                        .filter(tm => myManagedTeams.includes(tm.team))
                        .filter(tm => tm.email && tm.email.toLowerCase() !== (currentUser?.email || '').toLowerCase())
                        .flatMap(tm => {
                             const colleague = colleagues.find(c => c.email === tm.email);
                             return [tm.email, tm.email?.toLowerCase(), colleague?.id].filter(Boolean);
                        });

                    scopeFiltered = tasks.filter(t => {
                        const a = t.assignee; 
                        if (!a) return false;
                        if (a === currentUser?.id || a === currentUser?.email) return false;
                        return teamMemberIdentifiers.includes(a) || teamMemberIdentifiers.includes(a.toLowerCase());
                    });
                }
                
                // Ensure Trash filter handles its scope logically
                if (taskFilter === 'trash') {
                    return scopeFiltered.filter(t => t.deleted);
                }

                // Filter out deleted tasks for normal views
                scopeFiltered = scopeFiltered.filter(t => !t.deleted);

                if (taskFilter === 'all') return scopeFiltered;
                if (taskFilter === 'completed') return scopeFiltered.filter(t => (t.status === 'completed' || t.done));
                if (taskFilter === 'pending') return scopeFiltered.filter(t => (t.status !== 'completed' && !t.done));
                return scopeFiltered;
            }, [tasks, taskFilter, taskScope, currentUser, teamMembers, session, isManager]);

            if (loading) return <div className="h-full flex items-center justify-center h-screen bg-gray-50 dark:bg-gray-900 transition-colors"><div className="text-center text-gray-500 dark:text-gray-400 animate-pulse"><p>Loading Tempo Tasks...</p></div></div>;

            if (!session) {
                if (view === 'reset_password') return <PasswordResetScreen onReset={handleUpdatePassword} />;
                return <LoginScreen onLogin={handleGoogleLogin} onEmailLogin={handleEmailLogin} onPasswordLogin={handlePasswordLogin} onSignUp={handleSignUp} onPasswordReset={handlePasswordReset} />;
            }
            
            if (view === 'reset_password') return <PasswordResetScreen onReset={handleUpdatePassword} />;

            return (
                <div className="flex flex-col h-screen bg-gray-50 dark:bg-gray-900 transition-colors">
                    {view === 'dashboard' ? (
                        <>
                            <AppHeader currentUser={currentUser} onLogout={handleLogout} onSync={handleSync} dbStatus={dbStatus} isSyncing={isSyncing} syncRange={syncRange} setSyncRange={setSyncRange} lastSynced={lastSynced} isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode}/>
                            <main className="flex-1 overflow-y-auto p-6"><div className="max-w-5xl mx-auto">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                    <div><h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100">{dashboardViewMode === 'meetings' ? 'My Meetings' : (dashboardViewMode === 'tasks' ? 'My Tasks' : (dashboardViewMode === 'team' ? 'Team' : 'Reports'))}</h2><p className="text-gray-500 dark:text-gray-400 text-sm mt-1">{currentUser.name}</p></div>
                                    <div className="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                                        <div className="flex items-center space-x-1 bg-white dark:bg-gray-800 p-1 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm w-full sm:w-auto transition-colors">
                                            <button onClick={() => setDashboardViewMode('meetings')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'meetings' ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Meetings</button>
                                            <button onClick={() => setDashboardViewMode('tasks')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'tasks' ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Tasks</button>
                                            
                                            {currentUser.system_role === 'admin' && (
                                                <>
                                                    <button onClick={() => setDashboardViewMode('team')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'team' ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Team</button>
                                                    <button onClick={() => setDashboardViewMode('reports')} className={`flex-1 sm:flex-none px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${dashboardViewMode === 'reports' ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>Reports</button>
                                                </>
                                            )}
                                        </div>
                                        {dashboardViewMode === 'meetings' && (
                                            <div className="flex items-center gap-2">
                                                <div className="relative w-full sm:w-auto">
                                                    {isManager && (<div className="flex items-center bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-0.5 mb-2 sm:mb-0 sm:mr-2 transition-colors"><button onClick={() => setMeetingScope('me')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${meetingScope === 'me' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-400'}`}>Me</button><button onClick={() => setMeetingScope('team')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${meetingScope === 'team' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-400'}`}>My Team</button></div>)}
                                                    <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-tempo-blue shadow-sm"/><Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none" />
                                                </div>
                                                {selectedDate ? (
                                                    <button onClick={() => setSelectedDate('')} className="text-xs text-tempo-blue dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline whitespace-nowrap">Show All</button>
                                                ) : (
                                                    <button onClick={() => setShowPast(!showPast)} className={`text-xs px-2 py-1 rounded border ${showPast ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-400 border-tempo-blue/20 dark:border-blue-800' : 'text-gray-500 dark:text-gray-400 border-transparent hover:bg-gray-100 dark:hover:bg-gray-800'}`}>
                                                        {showPast ? 'Hide Past' : 'Show Past'}
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                        {dashboardViewMode === 'tasks' && (
                                            <div className="flex gap-2 w-full sm:w-auto items-center">
                                                <div className="flex items-center bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-0.5 transition-colors">
                                                    <button onClick={() => setTaskScope('me')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${taskScope === 'me' && taskFilter !== 'trash' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-400'}`} disabled={taskFilter === 'trash'}>Me</button>
                                                    <button onClick={() => setTaskScope('assigned_by_me')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${taskScope === 'assigned_by_me' && taskFilter !== 'trash' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-400'}`} disabled={taskFilter === 'trash'}>Assigned by Me</button>
                                                    {isManager && <button onClick={() => setTaskScope('team')} className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors ${taskScope === 'team' && taskFilter !== 'trash' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'text-gray-500 dark:text-gray-400'}`} disabled={taskFilter === 'trash'}>My Team</button>}
                                                </div>
                                                
                                                {/* ADMIN DELETE BUTTON */}
                                                {currentUser.system_role === 'admin' && (
                                                    <button 
                                                        onClick={handleDeleteAllTasks} 
                                                        className="bg-tempo-red/10 dark:bg-tempo-red/20 text-tempo-red dark:text-red-400 p-2 rounded-lg hover:bg-tempo-red/20 dark:hover:bg-tempo-red/30 transition-colors" 
                                                        title="Delete ALL Tasks (Admin Only)"
                                                    >
                                                        <Icon name="Trash2" className="w-4 h-4" />
                                                    </button>
                                                )}

                                                <div className="flex items-center bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-0.5 transition-colors">
                                                    <button 
                                                        onClick={() => setTaskFilter('pending')} 
                                                        className={`px-3 py-1.5 text-xs font-medium rounded-md flex items-center gap-1.5 transition-colors ${taskFilter === 'pending' ? 'bg-tempo-yellow/20 dark:bg-tempo-yellow/20 text-yellow-800 dark:text-yellow-500 shadow-sm border border-tempo-yellow/30 dark:border-yellow-800' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 border border-transparent'}`}
                                                    >
                                                        <Icon name="Circle" className="w-3 h-3" />
                                                        Pending
                                                    </button>
                                                    <button 
                                                        onClick={() => setTaskFilter('completed')} 
                                                        className={`px-3 py-1.5 text-xs font-medium rounded-md flex items-center gap-1.5 transition-colors ${taskFilter === 'completed' ? 'bg-tempo-blue/10 dark:bg-tempo-blue/20 text-tempo-blue dark:text-blue-400 shadow-sm border border-tempo-blue/20 dark:border-blue-800' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 border border-transparent'}`}
                                                    >
                                                        <Icon name="CheckCircle2" className="w-3 h-3" />
                                                        Completed
                                                    </button>
                                                    <button 
                                                        onClick={() => setTaskFilter('trash')} 
                                                        className={`px-3 py-1.5 text-xs font-medium rounded-md flex items-center gap-1.5 transition-colors ${taskFilter === 'trash' ? 'bg-tempo-red/10 dark:bg-tempo-red/20 text-tempo-red dark:text-red-400 shadow-sm border border-tempo-red/20 dark:border-red-800' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 border border-transparent'}`}
                                                    >
                                                        <Icon name="Trash2" className="w-3 h-3" />
                                                        Trash
                                                    </button>
                                                </div>

                                                <button onClick={() => setShowQuickAdd(!showQuickAdd)} className="bg-tempo-blue text-white p-2 rounded-lg hover:bg-tempo-hover" title="Add Personal Task"><Icon name="Plus" className="w-4 h-4" /></button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {dbStatus === 'setup_required' && ( <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-6 rounded-lg mb-6"><h3 className="font-bold text-red-900 dark:text-red-400 mb-2">Database Missing Tables</h3><p className="text-sm text-red-700 dark:text-red-300 mb-4">Run this SQL in your Supabase Dashboard:</p><div className="bg-gray-900 text-gray-100 p-3 rounded text-xs overflow-auto max-h-32 mb-4"><pre>{SQL_SETUP_INSTRUCTIONS}</pre></div><button onClick={() => fetchData(client)} className="bg-red-600 text-white px-4 py-2 rounded text-sm">Retry Connection</button></div> )}

                                {dashboardViewMode === 'meetings' ? (
                                    <>{sortedMeetings.length > 0 ? (<div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">{sortedMeetings.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => { setSelectedMeetingId(m.id); setView('meeting'); }} onAutoImport={(m, s) => handleImportFromDoc(m, s)} />)}</div>) : (<div className="text-center py-20 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700"><p className="text-gray-500 dark:text-gray-400">No meetings found {selectedDate ? `for ${selectedDate}` : ''}.</p>{dbStatus === 'empty' && <p className="text-sm text-tempo-blue dark:text-blue-400 mt-2">Click "Sync" to load from Google.</p>}</div>)}</>
                                ) : dashboardViewMode === 'tasks' ? (
                                    <div className="space-y-4">
                                        {showQuickAdd && (
                                            <div className="bg-white dark:bg-gray-800 border border-tempo-blue/20 dark:border-tempo-blue/50 p-4 rounded-lg shadow-sm mb-4 animate-in fade-in slide-in-from-top-2">
                                                <form onSubmit={(e) => { 
                                                    e.preventDefault(); 
                                                    handleAddStandaloneTask(
                                                        e.target.elements.taskText.value, 
                                                        e.target.elements.taskAssignee.value,
                                                        e.target.elements.taskStartDate.value,
                                                        e.target.elements.taskEndDate.value
                                                    ); 
                                                    e.target.reset(); 
                                                }} className="flex flex-col gap-2">
                                                    <div className="flex flex-col sm:flex-row gap-2">
                                                        <input name="taskText" type="text" placeholder="What do you need to do?" className="flex-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded px-3 py-2 text-sm focus:ring-2 focus:ring-tempo-blue outline-none" autoFocus />
                                                        <select name="taskAssignee" className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded px-3 py-2 text-sm focus:ring-2 focus:ring-tempo-blue outline-none" defaultValue={currentUser?.email}>
                                                            <option value={currentUser?.email}>Me</option>
                                                            {allPossibleAssignees.filter(u => u.email !== currentUser?.email).map(u => (
                                                                <option key={u.email} value={u.email}>{u.name || u.email}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    <div className="flex flex-col sm:flex-row gap-2 items-center">
                                                        <div className="flex items-center gap-1 w-full sm:w-auto">
                                                            <span className="text-xs text-gray-500 dark:text-gray-400">Start:</span>
                                                            <input name="taskStartDate" type="date" defaultValue={getTodayISO()} className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded px-2 py-1 text-xs focus:ring-2 focus:ring-tempo-blue outline-none" />
                                                        </div>
                                                        <div className="flex items-center gap-1 w-full sm:w-auto">
                                                            <span className="text-xs text-gray-500 dark:text-gray-400">Due:</span>
                                                            <input name="taskEndDate" type="date" defaultValue={getTodayISO()} className="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded px-2 py-1 text-xs focus:ring-2 focus:ring-tempo-blue outline-none" />
                                                        </div>
                                                        <button type="submit" className="bg-tempo-blue hover:bg-tempo-hover text-white px-4 py-1.5 rounded text-sm font-medium whitespace-nowrap ml-auto transition-colors">Add Task</button>
                                                    </div>
                                                </form>
                                            </div>
                                        )}
                                        {filteredTasks.length > 0 ? (filteredTasks.map(t => { const mtg = meetings.find(m => m.id === t.meetingId); const user = allPossibleAssignees.find(c => c.email === t.assignee || c.id === t.assignee) || { name: 'Unknown' }; t.assigneeName = user.name || user.email; return (<TaskCard key={t.id} task={t} meetingTitle={mtg ? mtg.title : (t.meeting_id === 'standalone' ? 'Personal Task' : 'Unknown Meeting')} onStatusChange={(id, val) => handleUpdateTask(id, { status: val, done: val === 'completed' })} onObstacleChange={(id, val) => handleUpdateTask(id, { obstacles: val })} onDateChange={(id, val) => handleUpdateTask(id, { end_date: val })} currentUser={currentUser} onDelete={handleDeleteTask} onUpdateText={handleUpdateText} onRestore={handleRestoreTask} isTrash={t.deleted} />); })) : (<div className="text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 text-gray-500 dark:text-gray-400">No tasks found matching filter.</div>)}
                                    </div>
                                ) : dashboardViewMode === 'team' ? (
                                    <TeamList teamMembers={teamMembers} colleagues={colleagues} onAddMember={handleAddTeamMember} onUpdateMember={handleUpdateTeamMember} onRemoveMember={handleRemoveTeamMember}/>
                                ) : ( <ReportsView meetings={meetings} tasks={tasks} attendees={allPossibleAssignees} teamMembers={teamMembers} /> )}
                            </div></main>
                        </>
                    ) : (
                        view === 'meeting' && meetings.find(x => x.id === selectedMeetingId) && (
                            <>
                                <AppHeader currentUser={currentUser} onLogout={handleLogout} dbStatus={dbStatus} onBack={() => setView('dashboard')} title={meetings.find(x => x.id === selectedMeetingId).title} meeting={meetings.find(x => x.id === selectedMeetingId)} isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} />
                                <div className="flex-1 overflow-hidden flex flex-col">
                                    <TaskManager tasks={tasks.filter(t => t.meetingId === selectedMeetingId)} attendees={allPossibleAssignees} currentUserEmail={currentUser?.email} onUpdateTask={handleUpdateTask} currentUser={currentUser} onDelete={handleDeleteTask} onUpdateText={handleUpdateText} onRestore={handleRestoreTask}
                                    onAdd={(mId, text, assignee, start, end) => { 
                                        const newId = `t_${Date.now()}_${Math.floor(Math.random() * 1000)}`; 
                                        const newTaskObj = { id: newId, meeting_id: mId, text, assignee, assigner: currentUser.email, status: 'pending', start_date: start, end_date: end, deleted: false, done: false };
                                        setTasks(prev => [...prev, { ...newTaskObj, meetingId: mId }]); 
                                        
                                        if (dbStatus === 'connected' && client) { 
                                            client.from('tasks').insert(newTaskObj).then(({ error }) => {
                                                if (error) {
                                                    console.error("Task Insert Error:", error);
                                                    showToast("Failed to save task. Database schema might be outdated. Please run the SQL Setup script again.");
                                                } else {
                                                    const m = meetings.find(x => x.id === selectedMeetingId);
                                                    scheduleAssignmentNotification(newTaskObj, m.title, m.id);
                                                }
                                            }); 
                                        } 
                                    }} 
                                    meetingId={selectedMeetingId} teamMembers={teamMembers} onImport={() => handleImportFromDoc(meetings.find(x => x.id === selectedMeetingId))} />
                                </div>
                            </>
                        )
                    )}

                    {/* Global Toast Notification */}
                    {toast && (
                        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-5 py-3 rounded-lg shadow-2xl flex items-center gap-4 z-50 animate-in slide-in-from-bottom-5 fade-in duration-300 border border-gray-700 dark:border-gray-200">
                            <span className="text-sm font-medium">{toast.message}</span>
                            {toast.onUndo && (
                                <button 
                                    onClick={toast.onUndo}
                                    className="text-tempo-blue dark:text-tempo-blue font-bold text-sm hover:opacity-80 transition-colors uppercase tracking-wider pl-2 border-l border-gray-700 dark:border-gray-200"
                                >
                                    Undo
                                </button>
                            )}
                            <button onClick={() => setToast(null)} className="text-gray-400 dark:text-gray-500 hover:text-white dark:hover:text-black ml-1">
                                <Icon name="X" className="w-4 h-4" />
                            </button>
                        </div>
                    )}

                    {/* Global Confirm Dialog */}
                    {dialogConfig && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full shadow-2xl border border-gray-200 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">
                                    {dialogConfig.type === 'confirm' ? 'Confirm Action' : 'Notice'}
                                </h3>
                                <p className="text-sm text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-wrap">
                                    {dialogConfig.message}
                                </p>
                                <div className="flex justify-end gap-3">
                                    {dialogConfig.type === 'confirm' && (
                                        <button onClick={() => setDialogConfig(null)} className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                            Cancel
                                        </button>
                                    )}
                                    <button onClick={() => {
                                        if(dialogConfig.onConfirm) dialogConfig.onConfirm();
                                        setDialogConfig(null);
                                    }} className={`px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors ${dialogConfig.type === 'confirm' ? 'bg-tempo-red hover:bg-red-700' : 'bg-tempo-blue hover:bg-blue-700'}`}>
                                        {dialogConfig.type === 'confirm' ? 'Proceed' : 'OK'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
